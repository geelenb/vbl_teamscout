<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>

    <title>Overzicht reeks</title>

    <script src="libs/dexie.js"></script>
    <script src="libs/plotly-2.9.0.min.js"></script>
    
    <script src="fetching.js?v=2"></script>
    <script src="vis.js?v=2"></script>
    <script src="gebeurtenis_data.js?v=2"></script>


    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>

    <style type="text/css">
        .colhead, .rowhead {
            font-weight: bold;
        }
        .colhead, .diagonal {
            text-align: center;
        }
        .rowhead {
            text-align: right;
        }
        .home_win, .away_win {
            font-family: monospace;
            text-align: center;
        }
        .home_win {
            background: lightblue;
        }
        .away_win {
            background: mistyrose;
        }
        #crosstable a {
            color: unset;
            text-decoration: unset;
        }
    </style>
</head>
<body>
    <h1>Javascript staat uit!</h1>
    <table id="stand"></table>

    <!-- 
        naam
        record 
        pct 
        home record 
        home pct 
        away record 
        away pct 
        avg own score 
        highest own score 
        lowest own score 
        highest score against 
        lowest score against 
        biggest win 
        smallest win 
        smallest loss 
        biggest loss 
        avg fouls 
        avg # players 
        FT pct 
        FTA
        avg 3PT
        avg age 
        oldest 
        youngest 
    -->

    <table id="crosstable"></table>
    <table id="players"></table>
    <div id="plus_minus_plot" style="height:90vmin; width:90vmin"></div>

    <script type="text/javascript">
        function record_of_team(games, team_guid) {
            const played_games = games.filter(g => g['uitslag']);
            const home_games = played_games.filter(g=> g.tTGUID === team_guid);
            const away_games = played_games.filter(g=> g.tUGUID === team_guid);

            const home_wins = n_home_wins_in_games(home_games);
            const home_losses = home_games.length - home_wins;
            const away_losses = n_home_wins_in_games(away_games);
            const away_wins = away_games.length - away_losses;

            return [home_wins + away_wins, home_losses + away_losses];
        }

        function percentage_of_team(games, team_guid) {
            let [W, L] = record_of_team(games, team_guid);
            return W / (W + L);
        }

        function td(contents, classes) {
            return `<td class="${classes}">${contents}</td>`
        }

        function make_cross_table(games) {
            let all_team_guids = [...new Set(games.map(g => g.tTGUID))];

            // sort by percentage: 
            // all_team_guids = all_team_guids.sort(guid => - percentage_of_team(games, guid));
            all_team_guids = all_team_guids.sort((a, b) => percentage_of_team(games, b) - percentage_of_team(games, a));
            
            const team_guid_to_i = Object.fromEntries(all_team_guids.map((guid, i) => [guid, i]));
            const team_guid_to_name = Object.fromEntries(games.map(g => [g.tTGUID, g.tTNaam]));

            let table_innerhtml = []
            table_innerhtml.push(
                    "<tr>",
                    td("Home \\ away", "colhead rowhead"),
                    ...all_team_guids.flatMap(guid => td(shorten_teamname_more(team_guid_to_name[guid]), "colhead")),
                    "</tr>",
            );


            all_team_guids.forEach((home_team_guid, i) => {
                table_innerhtml.push(
                    "<tr>",
                    td(shorten_teamname(team_guid_to_name[home_team_guid]), "rowhead"),
                )

                all_team_guids.forEach((away_team_guid, j) => {
                    if (i === j) {
                        // const percentage_str = percentage_of_team(games, home_team_guid).toFixed(3),
                        const record_str = record_of_team(games, home_team_guid).join("-");
                        table_innerhtml.push(td(`(${record_str})`, 'diagonal'));
                        return;
                    }

                    const game = games.find(g => g.tTGUID === home_team_guid && g.tUGUID === away_team_guid);
                    if (!game) {
                        table_innerhtml.push(td("???", 'diagonal'));
                        return;
                    }
                    const url = `match_grafiek.html?game_id=${game.guid}`;
                    const a = s => `<a href=${url}>${s}</a>`
                    const uitslag = game["uitslag"];
                    if (uitslag) {
                        const home_win = (uitslag.substring(0, 3) - uitslag.substring(4, 7)) > 0;
                        const cell_class = home_win ? "home_win" : "away_win";
                        table_innerhtml.push(td(a(uitslag.substring(0, 7).replaceAll(' ', '')), cell_class));
                    } else {
                        const [d, m, y] = game['datumString'].split('-')
                        const date_str = `${Number(d)} ${short_months[Number(m)]}`;
                        table_innerhtml.push(td(a(date_str, 'date')));
                    }

                    // End of cell
                });

                // add home record column?
                table_innerhtml.push(
                    "</tr>",
                )

                // row made, End of home team
            });

            // add row with away records?

            document.getElementById('crosstable').innerHTML = table_innerhtml.join('');
        }


        function make_players_table(previous_games, rosters, gebeurtenis_data) {
            const all_players_with_duplicates = rosters
                .flatMap(r => [...r['TuDeel'], ...r['TtDeel']])
                .filter(p => p['Functie'] == 'S');

            const relguid_to_player = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, p]));
            const relguid_to_teamnaam = Object.fromEntries(rosters.flatMap(
                (r, i) => [
                    ...r['TtDeel'].map(p => [p['RelGUID'], previous_games[i]['tTNaam']]),
                    ...r['TuDeel'].map(p => [p['RelGUID'], previous_games[i]['tUNaam']]),
                ]));
            const all_gebeurtenissen = gebeurtenis_data.flatMap(g => g['GebNis']).filter(g => g['GebStatus'] === 10);

            const on_court_plus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_court_minus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_bench_plus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_bench_minus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));

            previous_games.forEach((game, i) => {
                const roster = rosters[i];
                const game_gebeurtenissen = gebeurtenis_data[i];

                const players_on_field = {T: [], U: []};
                const players_on_bench = {
                    T: roster.TtDeel.filter(player => player['Functie'] === 'S').map(player => player.RelGUID), 
                    U: roster.TuDeel.filter(player => player['Functie'] === 'S').map(player => player.RelGUID)
                };

                game_gebeurtenissen.GebNis.forEach(geb => {
                    if (geb.GebStatus !== 10) {
                        return;
                    }
                    const tofu = geb.TofU;
                    const opp = tofu === 'T' ? 'U' : 'T';

                    if (geb['GebType'] === 50) {
                        // wissel
                        if (geb['Text'] === 'in') {
                            players_on_field[tofu].push(geb['RelGUID']);
                            players_on_bench[tofu] = players_on_bench[tofu].filter(v => v !== geb['RelGUID']);
                        } else if (geb['Text'] === 'uit') {
                            players_on_bench[tofu].push(geb['RelGUID']);
                            players_on_field[tofu] = players_on_field[tofu].filter(v => v !== geb['RelGUID']);
                        }
                    } else if (geb['GebType'] === 10) {
                        // score
                        const score = Number(geb['Text'].split(' ')[0]);
                        players_on_field[tofu].forEach(relguid => on_court_plus[relguid] += score);
                        players_on_bench[tofu].forEach(relguid => on_bench_plus[relguid] += score);
                        players_on_field[opp].forEach(relguid => on_court_minus[relguid] += score);
                        players_on_bench[opp].forEach(relguid => on_bench_minus[relguid] += score);
                    }
                });

            });

            const make_top_row = () => {
                const cells = [
                    // "RugNr", // todo: most common number
                    "Relguid",
                    "Birthdate",
                    "Naam",
                    "Team",
                    "Games",
                    "Minutes",
                    "Minutes per game",
                    "Points",
                    "Points per game",
                    "High score",
                    "Threes",
                    "Trees per game",
                    "Fouls",
                    "Fouls per game",
                    "Non personal fouls",
                    "Plus",
                    "Minus",
                    "Plus minus",
                    "Plus per minute",
                    "Minus per minute",
                    "Plus minus per minute",
                    "Benched plus",
                    "Benched minus",
                    "Benched plus minus",
                    "Benched minutes",
                    "Benched plus per minute",
                    "Benched minus per minute",
                    "Benched plus minus per minute",
                    "Offensive improvement",
                    "Defensive improvement",
                    "Netto improvement",
                ].map(s => `<th>${s}</th>`).join('');

                return `<thead><tr>${cells}</tr></thead>`;
            }

            const data_for_player = (player) => {
                const relguid = player['RelGUID'];

                const player_games_indices = rosters.flatMap((roster, i) => 
                    [...roster.TtDeel, ...roster.TuDeel]
                    .filter(p => p['Functie'] == 'S')
                    .map(player => player['RelGUID'])
                    .includes(relguid) ? [i] : []
                );
                const player_previous_games = player_games_indices.map(i => previous_games[i]);
                const player_games_rosters = player_games_indices.map(i => rosters[i]);
                const player_games_gebeurtenis_data = player_games_indices.map(i => gebeurtenis_data[i]);

                const player_games_all_gebeurtenissen = player_games_gebeurtenis_data
                    .flatMap(g => g['GebNis'])
                    .filter(g => g['GebStatus'] === 10);

                const player_gebeurtenissen = player_games_all_gebeurtenissen.filter(g => g['RelGUID'] === relguid);
                const player_scores = player_gebeurtenissen.filter(g => g['GebType'] === 10);
                const player_fouten = player_gebeurtenissen.filter(g => g['GebType'] === 30);

                const birthdate = `${player.GebDat.substr(6, 4)}-${player.GebDat.substr(3, 2)}-${player.GebDat.substr(0, 2)}`
                const n_games = player_previous_games.length;
                const minutes = gebeurtenis_data.map(gd => minutes_for_player(gd, relguid)).reduce((a, b) => a+b, 0);
                const minutes_per_game = minutes / n_games;

                const points = player_scores.map(g => Number(g.Text.split(' ')[0])).reduce((a, b) => a+b, 0);
                const points_per_game = points / n_games;
                const high_score = Math.max(...
                    gebeurtenis_data.map(match_geb => match_geb.GebNis
                        .filter(g=> g['GebStatus'] === 10 && g['RelGUID'] === relguid && g['GebType'] === 10)
                        .map(g => Number(g.Text.split(' ')[0]))
                        .reduce((a, b) => a+b, 0)
                    )
                );

                const n_threes = player_scores.filter(g => g.Text[0] === "3").length;
                const n_trees_per_game = n_threes / n_games;

                const n_fouls = player_fouten.length;
                const n_fouls_per_game = n_fouls / n_games;
                const n_non_personal_fouls = player_fouten.filter(g => g.Text[0] !== 'P').length;

                const plus = on_court_plus[relguid];
                const minus = on_court_minus[relguid];
                const plus_minus = on_court_plus[relguid] - on_court_minus[relguid];

                const plus_per_minute = plus / minutes;
                const minus_per_minute = minus / minutes;
                const plus_minus_per_minute = plus_minus / minutes;

                const benched_plus = on_bench_plus[relguid];
                const benched_minus = on_bench_minus[relguid];
                const benched_plus_minus = on_bench_plus[relguid] - on_bench_minus[relguid];

                const benched_minutes = 40 * n_games - minutes;
                const benched_plus_per_minute = benched_plus / benched_minutes;
                const benched_minus_per_minute = benched_minus / benched_minutes;
                const benched_plus_minus_per_minute = benched_plus_minus / benched_minutes;

                const offensive_improvement = plus_per_minute - benched_plus_per_minute;
                const defensive_improvement = -(minus_per_minute - benched_minus_per_minute);
                const netto_improvement = plus_minus_per_minute - benched_plus_minus_per_minute;

                const data = {
                    "Nr": player['RugNr'], // todo: most common number
                    "relguid": relguid,
                    "birthdate": birthdate,
                    "player": player['Naam'],
                    "teamnaam": relguid_to_teamnaam[relguid],
                    "n_games": n_games,
                    "minutes": minutes,
                    "minutes_per_game": minutes_per_game,
                    "points": points,
                    "points_per_game": points_per_game,
                    "high_score": high_score,
                    "n_threes": n_threes,
                    "n_trees_per_game": n_trees_per_game,
                    "n_fouls": n_fouls,
                    "n_fouls_per_game": n_fouls_per_game,
                    "n_non_personal_fouls": n_non_personal_fouls,
                    "plus": plus,
                    "minus": minus,
                    "plus_minus": plus_minus,
                    "plus_per_minute": plus_per_minute,
                    "minus_per_minute": minus_per_minute,
                    "plus_minus_per_minute": plus_minus_per_minute,
                    "benched_plus": benched_plus,
                    "benched_minus": benched_minus,
                    "benched_plus_minus": benched_plus_minus,
                    "benched_minutes": benched_minutes,
                    "benched_plus_per_minute": benched_plus_per_minute,
                    "benched_minus_per_minute": benched_minus_per_minute,
                    "benched_plus_minus_per_minute": benched_plus_minus_per_minute,
                    "offensive_improvement": offensive_improvement,
                    "defensive_improvement": defensive_improvement,
                    "netto_improvement": netto_improvement,
               };

               return data;
            }

            const row_from_data = (data) => {
                const cells = [
                    // data.Nr,
                    data.relguid,
                    data.birthdate,
                    data.player,
                    data.teamnaam,
                    data.n_games,
                    data.minutes.toFixed(1),
                    data.minutes_per_game.toFixed(1),
                    data.points,
                    data.points_per_game.toFixed(1),
                    data.high_score,
                    data.n_threes,
                    data.n_trees_per_game.toFixed(1),
                    data.n_fouls,
                    data.n_fouls_per_game.toFixed(1),
                    data.n_non_personal_fouls,
                    data.plus,
                    data.minus,
                    data.plus_minus,
                    data.plus_per_minute.toFixed(2),
                    data.minus_per_minute.toFixed(2),
                    data.plus_minus_per_minute.toFixed(2),
                    data.benched_plus,
                    data.benched_minus,
                    data.benched_plus_minus,
                    data.benched_minutes.toFixed(1),
                    data.benched_plus_per_minute.toFixed(2),
                    data.benched_minus_per_minute.toFixed(2),
                    data.benched_plus_minus_per_minute.toFixed(2),
                    data.offensive_improvement.toFixed(2),
                    data.defensive_improvement.toFixed(2),
                    data.netto_improvement.toFixed(2),
               ].map(v => td(v, ''));

                const joined_string = [
                    '<tr>', 
                    ...cells,
                    '</tr>'
                ].join('');

                return joined_string;

            }

            const datas = Object.values(relguid_to_player).map(data_for_player);
            const rows = [
                make_top_row(),
                ...datas.map(row_from_data),
            ];

            document.getElementById('players').innerHTML = rows.join('');

            window.table = new DataTable("#players", {paging: false,});

            return datas;
        }
        
        const plus_minus_trace_for_player = (player) => {
            return {
                x: [player.benched_plus_per_minute, player.plus_per_minute],
                y: [player.benched_minus_per_minute, player.minus_per_minute],
                type: 'scatter',
                // mode: 'lines',
                name: player.player,
                marker: {
                    symbol: ["none", 'circle'],
                    size: [0, 6],
                },
            }
        }

        function make_plus_minus_plot(player_datas) {
            const data = player_datas.map(plus_minus_trace_for_player);
            const layout = {
              xaxis: {
                title: "plus per minute"
              },
              yaxis: {
                title: "minus per minute"
              },

            }
            window.plus_minus_plot = Plotly.newPlot('plus_minus_plot', data, layout);
        }

        function connect_table_search_to_plot() {
            window.table.on('search', function (event, table_state) {
                make_plus_minus_plot(table_state.aiDisplay.map(i => player_datas[i]));
                // let data = table_state.aiDisplay.map(i => player_datas[i]).map(plus_minus_trace_for_player);
                // window.plus_minus_plot = Plotly.newPlot('plus_minus_plot', data);
                // window.plus_minus_plot.data = data;
                // Plotly.redraw('plus_minus_plot');
                // window.plus_minus_plot = Plotly.newPlot('plus_minus_plot', data);
            });
        }

        addEventListener('load', async () => {
            const poule_guid = (new URLSearchParams(window.location.search)).get('pouleGUID');
            document.querySelector('h1').innerText = 'Laden...';

            all_games =  fetch_poule_games(poule_guid);

            all_games = await all_games;
            g = all_games[0];

            played_games = all_games.filter(g => g['uitslag']);

            played_guids = played_games.map(g=> g.guid);

            rosters = fetch_team_rosters_for_games(played_games);
            gebeurtenis_data = fetch_gebeurtenis_data_for_games(played_games);

            rosters = await rosters;
            gebeurtenis_data = await gebeurtenis_data;

            gebeurtenis_data.forEach(gdi => {
                gdi.GebNis = add_fake_minute_to_gebnis(gdi.GebNis);
                gdi.GebNis = add_detailed_minute_to_gebnis(gdi.GebNis);
            });
            
            document.querySelector('h1').innerText = all_games[0]['pouleNaam'];

            make_cross_table(all_games);

            window.player_datas = make_players_table(played_games, rosters, gebeurtenis_data);

            make_plus_minus_plot(player_datas);

            connect_table_search_to_plot();
        });

    </script>
</body>
</html>