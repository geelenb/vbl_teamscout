<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>

    <title>Overzicht reeks</title>

    <script src="libs/dexie.js"></script>
    <script src="libs/plotly-2.9.0.min.js"></script>
    
    <script src="fetching.js?v=3"></script>
    <script src="vis.js?v=3"></script>
    <script src="gebeurtenis_data.js?v=3"></script>
    <script src="itertools.js?v=3"></script>
    <script src="common.js?v=3"></script>


    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/4.2.1/css/fixedColumns.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/fixedcolumns/4.2.1/js/dataTables.fixedColumns.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.3.1/css/fixedHeader.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/fixedheader/3.3.1/js/dataTables.fixedHeader.min.js"></script>

    <style type="text/css">
        body {
        }
        .colhead, .rowhead {
            font-weight: bold;
        }
        .colhead, .diagonal {
            text-align: center;
        }
        .rowhead {
            text-align: right;
        }
        .home_win, .away_win {
            font-family: monospace;
            text-align: center;
            color: unset;
            text-decoration: unset;
        }
        .home_win {
            background: lightblue;
        }
        .away_win {
            background: mistyrose;
        }
        #crosstable tbody a {
            color: unset;
            text-decoration: unset;
            width: 100%;
            display: block;
        }
        .js-plotly-plot {
            margin-top: 5vmin;
        }
        g.textpoint text {
            stroke: black;
            font-weight: bold;
        }
        body.loading #js {
            display: none;
        }
        body > #loading_msg {
            display: none;
        }
        body.loading > #loading_msg {
            display: initial;
        }
        .figure {
            height: 98vmin;
            width: 98vmin;
        }
    </style>
</head>
<body>
    <h1 id="js">Javascript staat uit!</h1>
    <h1 id="loading_msg">Laden...</h1>
    <table id="stand"></table>

    <!-- 
        naam
        record 
        pct 
        home record 
        home pct 
        away record 
        away pct 
        avg own score 
        highest own score 
        lowest own score 
        highest score against 
        lowest score against 
        biggest win 
        smallest win 
        smallest loss 
        biggest loss 
        avg fouls 
        avg # players 
        FT pct 
        FTA
        avg 3PT
        avg age 
        oldest 
        youngest 
    -->

    <table id="crosstable"></table>

    <table id="players_table"></table>

    <br>
    <div id="netto_improvement_plot" class="figure" ></div>
    <div id="offense_defense_difference_plot" class="figure" ></div>
    <div id="usage_plot" class="figure" ></div>
    <div id="offense_defense_plot" class="figure" ></div>

    <script type="text/javascript">
        function record_of_team(games, team_guid) {
            const played_games = games.filter(g => g['uitslag']);
            const home_games = played_games.filter(g=> g.tTGUID === team_guid);
            const away_games = played_games.filter(g=> g.tUGUID === team_guid);

            const home_wins = n_home_wins_in_games(home_games);
            const home_losses = home_games.length - home_wins;
            const away_losses = n_home_wins_in_games(away_games);
            const away_wins = away_games.length - away_losses;

            return [home_wins + away_wins, home_losses + away_losses];
        }

        function percentage_of_team(games, team_guid) {
            let [W, L] = record_of_team(games, team_guid);
            return W / (W + L);
        }

        function td(contents, classes) {
            return `<td class="${classes}">${contents}</td>`
        }

        const a = (href, contents) => `<a href='${href}'>${contents}</a>`;

        function make_cross_table(games) {
            // sort by percentage: 
            const all_team_guids_sorted = [...new Set(games.map(g => g.tTGUID))];
            all_team_guids_sorted.sort((a, b) => percentage_of_team(games, b) - percentage_of_team(games, a));
            
            const team_guid_to_i = Object.fromEntries(all_team_guids_sorted.map((guid, i) => [guid, i]));
            const team_guid_to_name = Object.fromEntries(games.map(g => [g.tTGUID, g.tTNaam]));

            const rowhead_from_team_guid = guid => td(
                a(
                    `team.html?team=${guid}`, 
                    shorten_teamname(team_guid_to_name[guid]),
                ),
                'rowhead'
            ); 
            const colhead_from_team_guid = guid => td(
                a(
                    `team.html?team=${guid}`, 
                    shorten_teamname_more(team_guid_to_name[guid]),
                ),
                'colhead'
            ); 
            // const a_from_team_guid = guid => `<a href='team.html?team=${guid}'>${shorten_teamname_more(team_guid_to_name[guid])}</a>`; 

            let table_innerhtml = []
            table_innerhtml.push(
                "<thead><tr>",
                td("Home \\ away", "colhead rowhead"),
                ...all_team_guids_sorted.flatMap(guid => 
                    colhead_from_team_guid(guid)
                ),
                "</tr></thead>",
            );

            all_team_guids_sorted.forEach((home_team_guid, i) => {
                // Rij maken
                table_innerhtml.push(
                    "<tr>",
                    rowhead_from_team_guid(home_team_guid), // Eerste kolom
                );
                const home_games = games.filter(g => g.tTGUID === home_team_guid)

                all_team_guids_sorted.forEach((away_team_guid, j) => {
                    // Cel maken
                    if (i === j) {
                        // const percentage_str = percentage_of_team(games, home_team_guid).toFixed(3),
                        const record_str = record_of_team(games, home_team_guid).join("-");
                        table_innerhtml.push(td(`(${record_str})`, 'diagonal'));
                        return;
                    }

                    const game = home_games.find(g => g.tUGUID === away_team_guid);
                    if (!game) {
                        table_innerhtml.push(td("???", 'diagonal'));
                        return;
                    }

                    const url = `match_grafiek.html?game_id=${game.guid}`;
                    const a = s => `<a href=${url}>${s}</a>`
                    const uitslag = game["uitslag"];

                    if (uitslag) {
                        const home_win = uitslag.substring(0, 3) - uitslag.substring(4, 7) > 0;
                        const cell_class = home_win ? "home_win" : "away_win";
                        table_innerhtml.push(td(a(uitslag.substring(0, 7).replaceAll(' ', '')), cell_class));
                    } else {
                        const [d, m, y] = game['datumString'].split('-')
                        const date_str = `${Number(d)} ${short_months[Number(m)]}`;
                        table_innerhtml.push(td(a(date_str, 'date')));
                    }
                    // End of cell
                });

                // add home record column?
                const home_played_games = home_games.filter(g => g['uitslag']);
                const n_home_wins = n_home_wins_in_games(home_played_games);
                table_innerhtml.push(
                    // td(`${n_home_wins}-${home_played_games.length - n_home_wins}`),
                    "</tr>",
                )

                // row made, End of home team
            });

            // add row with away records?

            document.getElementById('crosstable').innerHTML = table_innerhtml.join('');
        }

        function make_players_table(previous_games, rosters, gebeurtenis_data) {
            const all_players_with_duplicates = rosters
                .flatMap(r => [...r['TuDeel'], ...r['TtDeel']])
                .filter(p => p['Functie'] == 'S');

            const relguid_to_player = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, p]));
            const relguid_to_teamnaam = Object.fromEntries(rosters.flatMap(
                (r, i) => [
                    ...r['TtDeel'].map(p => [p['RelGUID'], previous_games[i]['tTNaam']]),
                    ...r['TuDeel'].map(p => [p['RelGUID'], previous_games[i]['tUNaam']]),
                ]));
            const relguid_to_teamid = Object.fromEntries(rosters.flatMap(
                (r, i) => [
                    ...r['TtDeel'].map(p => [p['RelGUID'], previous_games[i]['tTGUID']]),
                    ...r['TuDeel'].map(p => [p['RelGUID'], previous_games[i]['tUGUID']]),
                ]));
            const all_gebeurtenissen = gebeurtenis_data.flatMap(g => g['GebNis']).filter(g => g['GebStatus'] === 10);

            const on_court_plus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_court_minus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_bench_plus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_bench_minus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));

            const relguid_to_roster_entries = groupBy(all_players_with_duplicates, p => p.RelGUID);
            const relguid_to_most_common_number = Object.fromEntries(
                Object.entries(relguid_to_roster_entries).map(
                    ([relguid, entries]) => [relguid, most_common_value(entries.map(p => p.RugNr))])
                );

            previous_games.forEach((game, i) => {
                const roster = rosters[i];
                const game_gebeurtenissen = gebeurtenis_data[i];

                const players_on_field = {T: [], U: []};
                const players_on_bench = {
                    T: roster.TtDeel.filter(player => player['Functie'] === 'S').map(player => player.RelGUID), 
                    U: roster.TuDeel.filter(player => player['Functie'] === 'S').map(player => player.RelGUID)
                };

                game_gebeurtenissen.GebNis.forEach(geb => {
                    if (geb.GebStatus !== 10) {
                        return;
                    }
                    const tofu = geb.TofU;
                    const opp = tofu === 'T' ? 'U' : 'T';

                    if (geb['GebType'] === 50) {
                        // wissel
                        if (geb['Text'] === 'in') {
                            players_on_field[tofu].push(geb['RelGUID']);
                            players_on_bench[tofu] = players_on_bench[tofu].filter(v => v !== geb['RelGUID']);
                        } else if (geb['Text'] === 'uit') {
                            players_on_bench[tofu].push(geb['RelGUID']);
                            players_on_field[tofu] = players_on_field[tofu].filter(v => v !== geb['RelGUID']);
                        }
                    } else if (geb['GebType'] === 10) {
                        // score
                        const score = Number(geb['Text'].split(' ')[0]);
                        players_on_field[tofu].forEach(relguid => on_court_plus[relguid] += score);
                        players_on_bench[tofu].forEach(relguid => on_bench_plus[relguid] += score);
                        players_on_field[opp].forEach(relguid => on_court_minus[relguid] += score);
                        players_on_bench[opp].forEach(relguid => on_bench_minus[relguid] += score);
                    }
                });

            });

            const make_top_row = () => {
                const cells = [
                    "Naam",
                    "Nr",
                    // "Relguid",
                    "Birthdate",
                    "Team",
                    "Games",
                    "Minutes",
                    "Minutes per game",
                    "Points",
                    "Points per game",
                    "Points per 40'",
                    "High score",
                    "Threes",
                    "Threes per game",
                    "Fouls",
                    "Fouls per game",
                    "Non personal fouls",
                    "Plus",
                    "Minus",
                    "Plus minus",
                    "Plus per minute",
                    "Minus per minute",
                    "Plus minus per minute",
                    "Benched plus",
                    "Benched minus",
                    "Benched plus minus",
                    "Benched minutes",
                    "Benched plus per minute",
                    "Benched minus per minute",
                    "Benched plus minus per minute",
                    "Offensive improvement",
                    "Defensive improvement",
                    "Netto improvement",
                ].map(s => `<th>${s}</th>`).join('');

                return `<thead><tr>${cells}</tr></thead>`;
            }

            const data_for_player = (player) => {
                const relguid = player['RelGUID'];

                const player_games_indices = rosters.flatMap((roster, i) => 
                    [...roster.TtDeel, ...roster.TuDeel]
                    .filter(p => p['Functie'] == 'S')
                    .map(player => player['RelGUID'])
                    .includes(relguid) ? [i] : []
                );
                const player_previous_games = player_games_indices.map(i => previous_games[i]);
                const player_games_rosters = player_games_indices.map(i => rosters[i]);
                const player_games_gebeurtenis_data = player_games_indices.map(i => gebeurtenis_data[i]);

                const player_games_all_gebeurtenissen = player_games_gebeurtenis_data
                    .flatMap(g => g['GebNis'])
                    .filter(g => g['GebStatus'] === 10);

                const player_gebeurtenissen = player_games_all_gebeurtenissen.filter(g => g['RelGUID'] === relguid);
                const player_scores = player_gebeurtenissen.filter(g => g['GebType'] === 10);
                const player_fouten = player_gebeurtenissen.filter(g => g['GebType'] === 30);

                const gd = player.GebDat || "";
                const birthdate = `${gd.substr(6, 4)}-${gd.substr(3, 2)}-${gd.substr(0, 2)}`
                const n_games = player_previous_games.length;
                const minutes = gebeurtenis_data.map(gd => minutes_for_player(gd, relguid)).reduce((a, b) => a+b, 0);
                const minutes_per_game = minutes / n_games;

                const points = player_scores.map(g => Number(g.Text.split(' ')[0])).reduce((a, b) => a+b, 0);
                const points_per_game = points / n_games;
                const points_per_40 = points / minutes * 40 || 0.0;
                const high_score = Math.max(...
                    gebeurtenis_data.map(match_geb => match_geb.GebNis
                        .filter(g=> g['GebStatus'] === 10 && g['RelGUID'] === relguid && g['GebType'] === 10)
                        .map(g => Number(g.Text.split(' ')[0]))
                        .reduce((a, b) => a+b, 0)
                    )
                );

                const n_threes = player_scores.filter(g => g.Text[0] === "3").length;
                const n_trees_per_game = n_threes / n_games;

                const n_fouls = player_fouten.length;
                const n_fouls_per_game = n_fouls / n_games;
                const n_non_personal_fouls = player_fouten.filter(g => g.Text[0] !== 'P').length;

                const plus = on_court_plus[relguid];
                const minus = on_court_minus[relguid];
                const plus_minus = on_court_plus[relguid] - on_court_minus[relguid];

                const plus_per_minute = plus / minutes || 0.0;
                const minus_per_minute = minus / minutes || 0.0;
                const plus_minus_per_minute = plus_minus / minutes || 0.0;

                const benched_plus = on_bench_plus[relguid];
                const benched_minus = on_bench_minus[relguid];
                const benched_plus_minus = on_bench_plus[relguid] - on_bench_minus[relguid];

                const benched_minutes = 40 * n_games - minutes;
                const benched_plus_per_minute = benched_plus / benched_minutes || 0.0;
                const benched_minus_per_minute = benched_minus / benched_minutes || 0.0;
                const benched_plus_minus_per_minute = benched_plus_minus / benched_minutes || 0.0;

                const offensive_improvement = plus_per_minute - benched_plus_per_minute;
                const defensive_improvement = -(minus_per_minute - benched_minus_per_minute);
                const netto_improvement = plus_minus_per_minute - benched_plus_minus_per_minute;

                const data = {
                    "Nr": relguid_to_most_common_number[relguid], // todo: most common number
                    "relguid": relguid,
                    "birthdate": birthdate,
                    "player": player['Naam'],
                    "team_relguid": relguid_to_teamid[relguid],
                    "teamnaam": relguid_to_teamnaam[relguid],
                    "n_games": n_games,
                    "minutes": minutes,
                    "minutes_per_game": minutes_per_game,
                    "points": points,
                    "points_per_game": points_per_game,
                    "points_per_40": points_per_40,
                    "high_score": high_score,
                    "n_threes": n_threes,
                    "n_trees_per_game": n_trees_per_game,
                    "n_fouls": n_fouls,
                    "n_fouls_per_game": n_fouls_per_game,
                    "n_non_personal_fouls": n_non_personal_fouls,
                    "plus": plus,
                    "minus": minus,
                    "plus_minus": plus_minus,
                    "plus_per_minute": plus_per_minute,
                    "minus_per_minute": minus_per_minute,
                    "plus_minus_per_minute": plus_minus_per_minute,
                    "benched_plus": benched_plus,
                    "benched_minus": benched_minus,
                    "benched_plus_minus": benched_plus_minus,
                    "benched_minutes": benched_minutes,
                    "benched_plus_per_minute": benched_plus_per_minute,
                    "benched_minus_per_minute": benched_minus_per_minute,
                    "benched_plus_minus_per_minute": benched_plus_minus_per_minute,
                    "offensive_improvement": offensive_improvement,
                    "defensive_improvement": defensive_improvement,
                    "netto_improvement": netto_improvement,
               };

               return data;
            }

            const row_from_data = (data) => {
                const cells = [
                    data.player.replaceAll(' ', '&nbsp;'),
                    data.Nr,
                    // data.relguid,
                    data.birthdate,
                    a('team.html?team=' + data.team_relguid, shorten_teamname(data.teamnaam).replaceAll(' ', '&nbsp;')),
                    data.n_games,
                    data.minutes.toFixed(1),
                    data.minutes_per_game.toFixed(1),
                    data.points,
                    data.points_per_game.toFixed(1),
                    data.points_per_40.toFixed(1),
                    data.high_score,
                    data.n_threes,
                    data.n_trees_per_game.toFixed(1),
                    data.n_fouls,
                    data.n_fouls_per_game.toFixed(1),
                    data.n_non_personal_fouls,
                    data.plus,
                    data.minus,
                    data.plus_minus,
                    data.plus_per_minute.toFixed(2),
                    data.minus_per_minute.toFixed(2),
                    data.plus_minus_per_minute.toFixed(2),
                    data.benched_plus,
                    data.benched_minus,
                    data.benched_plus_minus,
                    data.benched_minutes.toFixed(1),
                    data.benched_plus_per_minute.toFixed(2),
                    data.benched_minus_per_minute.toFixed(2),
                    data.benched_plus_minus_per_minute.toFixed(2),
                    data.offensive_improvement.toFixed(2),
                    data.defensive_improvement.toFixed(2),
                    data.netto_improvement.toFixed(2),
               ].map(v => td(v, ''));

                const joined_string = [
                    '<tr>', 
                    ...cells,
                    '</tr>'
                ].join('');

                return joined_string;

            }

            const datas = Object.values(relguid_to_player).filter(x => !x.RelGUID.startsWith('NA')).map(data_for_player);
            const rows = [
                make_top_row(),
                ...datas.map(row_from_data),
            ];

            document.getElementById('players_table').innerHTML = rows.join('');

            window.player_table = new DataTable("#players_table", {
                paging: false,
                fixedHeader: true,
                scrollX: true,
                fixedColumns: true,
            });

            return datas;
        }
        
        function make_offense_defense_plot(player_datas) {
            const offense_defense_trace_for_player = (player) => ({
                x: player.minutes ? [player.benched_plus_per_minute, player.plus_per_minute] : [],
                y: player.minutes ? [player.benched_minus_per_minute, player.minus_per_minute] : [],
                type: 'scatter',
                // mode: 'lines',
                text: [
                    `${shorten_teamname_more(player.teamnaam)} when ${player.player} is benched`,
                    `${shorten_teamname_more(player.teamnaam)} when ${player.player} is on court`,
                ],
                marker: {
                    symbol: ["none", 'circle'],
                    size: [0, 5 * Math.sqrt(player.minutes_per_game)],
                    size: [0, player.minutes_per_game],
                    color: team_guid_to_colour[player.team_relguid],
                },
                line: {
                    width: player.minutes ? 1 : 0,
                    color: team_guid_to_colour[player.team_relguid],
                },
                hoverinfo: 'text',
            });

            const traces = player_datas.map(offense_defense_trace_for_player);
            const layout = {
                title: "Plus &amp; minus per minute of teams when players are on and off court",
                xaxis: {
                    title: "Plus per Minute",
                },
                yaxis: {
                    title: "Minus per Minute",
                    scaleanchor: "x", 
                    autorange: 'reversed',
                },
                annotations: corner_annotations,
                dragmode: "pan",
                showlegend: false,
            }
            window.offense_defense_plot = Plotly.newPlot('offense_defense_plot', traces, layout, {scrollZoom: true});
        }

        function make_netto_improvement_plot(player_datas) {
            const plus_minus_trace_for_player = (player) => ({
                x: player.minutes ? [player.plus_minus_per_minute] : [],
                y: player.minutes ? [player.benched_plus_minus_per_minute] : [],
                // y: player.minutes ? [player.netto_improvement] : [],
                type: 'scatter',
                // mode: 'lines',
                text: [
                    `${player.player}<br>${shorten_teamname_more(player.teamnaam)}`
                ],
                marker: {
                    symbol: ["none", 'circle'],
                    size: [5 * Math.sqrt(player.minutes_per_game)],
                    size: [player.minutes_per_game],
                    color: team_guid_to_colour[player.team_relguid],
                },
                line: {
                    width: player.minutes ? 1 : 0,
                },
                hoverinfo: 'text',
            });
            
            const traces = player_datas.map(plus_minus_trace_for_player);

            if (data_is_of_one_team(player_datas)){
                traces.push(...numbers_traces_on_data(traces, player_datas));
            }

            const annotations = [
                {
                    ..._left_annotation,
                    ..._top_annotation,
                    text: '(Players rostered in losses)',
                }, {
                    ..._hmid_annotation,
                    ..._top_annotation,
                    text: '(Teammates are worse than opponents)',
                }, {
                    ..._right_annotation,
                    ..._top_annotation,
                    text: '(Team plays better with them on court)',
                }, {
                    ..._left_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Players worse than their opponents)',
                }, {
                    ..._right_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Players better than their opponents)',
                }, {
                    ..._left_annotation,
                    ..._bottom_annotation,
                    text: '(Team plays better with them benched)',
                }, {
                    ..._hmid_annotation,
                    ..._bottom_annotation,
                    text: '(Teammates are better than opponents)',
                }, {
                    ..._right_annotation,
                    ..._bottom_annotation,
                    text: '(Players rostered in wins)',
                }
            ].map(x => ({..._absolute_annotation, ...x}));

            const layout = {
                title: "Difference in +/- per minute between when player is benched and when playing",
                xaxis: {
                    title: "+/- per Minute on court",
                },
                yaxis: {
                    title: "Team +/- per Minute when benched",
                    scaleanchor: "x", 
                    autorange: 'reversed',
                },
                annotations: annotations,
                dragmode: "pan",
                showlegend: false,
            }
            window.netto_improvement_plot = Plotly.newPlot('netto_improvement_plot', traces, layout, {scrollZoom: true});
        }

        function make_usage_plot(player_datas) {
            const trace_for_player = (player) => ({
                x: [player.plus_per_minute],
                // y: [player.points_per_40 / 40 / player.plus_per_minute],
                y: [player.points_per_40 / 40],
                type: 'scatter',
                // mode: 'lines',
                text: [
                    [
                        player.player, 
                        shorten_teamname_more(player.teamnaam),
                        (player.points_per_40 / 40 / player.plus_per_minute * 100).toFixed(1) + '%',
                    ].join('<br>')
                ],
                marker: {
                    symbol: ["none", 'circle'],
                    size: [5 * Math.sqrt(player.minutes_per_game)],
                    size: [player.minutes_per_game],
                    color: team_guid_to_colour[player.team_relguid],
                },
                line: {
                    width: player.minutes ? 1 : 0,
                },
                hoverinfo: 'text',
            });
            const player_dots = player_datas.map(trace_for_player);

            const max_x = Math.max(...player_dots.map(t => t.x[0])) * 1.1;
            const max_y = Math.max(...player_dots.map(t => t.y[0])) * 1.1;

            const diagonals = (
                Array(10)
                .fill()
                .map((_, i) => i * 10 + 10)
                .map(pct => ({
                    x: [0, Math.min(max_x, max_y / pct * 100)],
                    y: [0, Math.min(max_y, max_x * pct / 100)],
                    text: ['', pct < 50 || pct % 20 === 0 ? `${pct}%` : ''],
                    textposition: 'top',
                    // z: 1000000,
                    mode: 'lines+text',
                    line: {
                        color: 'lightgrey',
                        width: 1,
                        dash: "dash",
                    },
                    hoverinfo: 'none',
                    textfont: {
                        color: 'white',
                    },
                    class: 'diagonals',
                }))
            );

            const traces = [...diagonals, ...player_dots,];

            if (data_is_of_one_team(player_datas)){
                traces.push(...numbers_traces_on_data(player_dots, player_datas));
            }

            const layout = {
                title: "Scoring sources: points stake when on court",
                xaxis: {
                    title: "Plus per minute",
                },
                yaxis: {
                    title: "Points per minute",
                },
                annotations: [{
                    x: max_y / (0.5),
                    y: max_y,
                    xref: 'x',
                    yref: 'y',
                    text: 'Players who score 50% of the team\'s points when they are playing',
                    showarrow: true,
                    align: 'center',
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: 'black',
                    ax: 20,
                    ay: -30,
                    bgcolor: 'white',
                }],
                dragmode: "pan",
                showlegend: false,
            }
            window.netto_improvement_plot = Plotly.newPlot('usage_plot', traces, layout, {scrollZoom: true});
        }

        function data_is_of_one_team(player_datas) {
            for (var i = 1; i < player_datas.length; i++) {
                if (player_datas[i].team_relguid !== player_datas[i-1].team_relguid) {
                    return false;
                }
            }
            return true;
        }

        function numbers_traces_on_data(player_traces, player_datas) {
            return player_datas.map((player, i) => ({
                x: player_traces[i].x,
                y: player_traces[i].y,
                mode: 'text',
                text: player.Nr,
                hoverinfo: 'none',

                textfont: {
                    color: 'white',
                },
            }));
        }

        function make_offense_defense_difference_plot(player_datas) {
            const trace_for_player = (player) => ({
                x: [player.offensive_improvement],
                y: [player.defensive_improvement],
                type: 'scatter',
                text: [
                    [
                        player.player, 
                        shorten_teamname_more(player.teamnaam),
                    ].join('<br>')
                ],
                marker: {
                    symbol: ["none", 'circle'],
                    size: [5 * Math.sqrt(player.minutes_per_game)],
                    size: [player.minutes_per_game],
                    color: team_guid_to_colour[player.team_relguid],
                },
                line: {
                    width: player.minutes ? 1 : 0,
                },
                hoverinfo: 'text',
            });
            const traces = player_datas.map(trace_for_player);

            if (data_is_of_one_team(player_datas)){
                traces.push(...numbers_traces_on_data(traces, player_datas));
            }
            
            const annotations = [
                {
                    ..._left_annotation,
                    ..._top_annotation,
                    text: '(Nobody scores when they play)',
                }, {
                    ..._hmid_annotation,
                    ..._top_annotation,
                    text: '(Good defenders)',
                }, {
                    ..._right_annotation,
                    ..._top_annotation,
                    text: '(Team plays better with them on court)',
                }, {
                    ..._left_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Bad attackers)',
                }, {
                    ..._right_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Good attackers)',
                }, {
                    ..._left_annotation,
                    ..._bottom_annotation,
                    text: '(Team plays better with them benched)',
                }, {
                    ..._hmid_annotation,
                    ..._bottom_annotation,
                    text: '(Bad defenders)',
                }, {
                    ..._right_annotation,
                    ..._bottom_annotation,
                    text: '(Both teams score when they play)',
                }
            ].map(x => ({..._absolute_annotation, ...x}));


            const layout = {
                title: "Difference in <i>plus per minute</i> and <i>minus per minute</i> of team when player is playing vs. benched",
                xaxis: {
                    title: "Difference in plus per minute of team when player is playing vs. benched (\"Offensive improvement\")",
                },
                yaxis: {
                    title: "Difference in minus per minute of team when player is playing vs. benched (\"Defensive improvement\")",
                    scaleanchor: "x", 
                    // autorange: 'reversed',
                },
                annotations: annotations,
                dragmode: "pan",
                showlegend: false,
            }
            window.netto_improvement_plot = Plotly.newPlot('offense_defense_difference_plot', traces, layout, {scrollZoom: true});
        }

        function make_plots(selected_player_datas) {
            make_offense_defense_plot(selected_player_datas);
            make_netto_improvement_plot(selected_player_datas);
            make_usage_plot(selected_player_datas);
            make_offense_defense_difference_plot(selected_player_datas);
        }

        function connect_table_search_to_plots() {
            window.player_table.on('search', function (event, table_state) {
                const value_before_wait = document.querySelector('input[type=search').value;
                window.setTimeout(
                    () => {
                        const value_after_wait = document.querySelector('input[type=search').value;
                        if (value_before_wait !== value_after_wait) {
                            return;
                        }
                        make_plots(table_state.aiDisplay.map(i => player_datas[i]));
                    },
                    1000
                )
            });
        }

        addEventListener('load', async () => {
            const poule_guid = (new URLSearchParams(window.location.search)).get('pouleGUID');
            document.body.classList.add('loading');

            all_games = fetch_poule_games(poule_guid);

            all_games = await all_games;
            g = all_games[0];

            played_games = all_games.filter(g => g['uitslag']);

            played_guids = played_games.map(g=> g.guid);

            // team_guid_to_colours = fetch_team_colours_from_games(all_games);
            const all_team_guids = [...new Set(all_games.map(g => g.tTGUID))];
            n_teams = all_team_guids.length;

            team_guid_to_colour = Object.fromEntries(all_team_guids.map((g, i) => [g, 
                `hsl(${i * 360 / n_teams}, ${i % 2 ? 0.4 : 0.8}, .4)`,
                // `${i}`
            ]))

            rosters = fetch_team_rosters_for_games(played_games);
            gebeurtenis_data = fetch_gebeurtenis_data_for_games(played_games);

            rosters = await rosters;
            gebeurtenis_data = await gebeurtenis_data;
            // team_guid_to_colours = await team_guid_to_colours;

            gebeurtenis_data.forEach(gdi => {
                gdi.GebNis = add_fake_minute_to_gebnis(gdi.GebNis);
                gdi.GebNis = add_detailed_minute_to_gebnis(gdi.GebNis);
            });
            
            document.querySelector('h1').innerText = all_games[0]['pouleNaam'];

            make_cross_table(all_games);

            window.player_datas = make_players_table(played_games, rosters, gebeurtenis_data);

            make_plots(player_datas);

            connect_table_search_to_plots();

            document.body.classList.remove('loading');
        });

    </script>
</body>
</html>