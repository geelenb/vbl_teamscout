<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>

    <title>Spelers in reeks</title>

    <script src="libs/dexie.js"></script>
    <script src="libs/plotly-2.9.0.min.js"></script>
    
    <script src="fetching.js?v=3"></script>
    <script src="vis.js?v=4"></script>
    <script src="gebeurtenis_data.js?v=3"></script>
    <script src="itertools.js?v=3"></script>
    <script src="common.js?v=3"></script>


    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/4.2.1/css/fixedColumns.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/fixedcolumns/4.2.1/js/dataTables.fixedColumns.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.3.1/css/fixedHeader.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/fixedheader/3.3.1/js/dataTables.fixedHeader.min.js"></script>

    <style>
        g.textpoint text {
            font-weight: bold;
        }
        body.loading #js {
            display: none;
        }
        body > #loading_msg {
            display: none;
        }
        body.loading > #loading_msg {
            display: initial;
        }
        .figure {
            height: 98vmin;
            width: 98vmin;
        }
        .teamid {
            font-size: small;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1 id="js">Javascript staat uit!</h1>

    <h1 id="loading_msg">Spelers laden...</h1>
    <p>
        <a id="poule_link">Reeksoverzicht</a>
        <a id="poule_teams_link">Ploegen in deze reeks</a>
    </p>
    <script type="text/javascript">
        document.getElementById('poule_link').href = 'poule.html' + window.location.search;
        document.getElementById('poule_teams_link').href = 'poule_teams.html' + window.location.search;
    </script>

    <table id="players_table" class="compact"></table>

    <br>
    <p>Use the search field of the table to filter the figures below.</p>

    <div id="offense_defense_plot" class="figure" ></div>
    <div id="offense_defense_difference_plot" class="figure" ></div>
    <div id="netto_improvement_plot" class="figure" ></div>
    <div id="shooting_plot" class="figure" ></div>
    <div id="usage_plot" class="figure" ></div>

    <script type="text/javascript">
        function td(contents, classes) {
            return `<td class="${classes}">${contents}</td>`
        }

        const a = (href, contents) => `<a href='${href}'>${contents}</a>`;

        function make_players_table(previous_games, rosters, gebeurtenis_data) {
            const all_players_with_duplicates = rosters
                .flatMap(r => [...r['TuDeel'], ...r['TtDeel']])
                .filter(p => p['Functie'] == 'S');

            const relguid_to_player = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, p]));
            const relguid_to_teamnaam = Object.fromEntries(rosters.flatMap(
                (r, i) => [
                    ...r['TtDeel'].map(p => [p['RelGUID'], previous_games[i]['tTNaam']]),
                    ...r['TuDeel'].map(p => [p['RelGUID'], previous_games[i]['tUNaam']]),
                ]));
            const relguid_to_teamid = Object.fromEntries(rosters.flatMap(
                (r, i) => [
                    ...r['TtDeel'].map(p => [p['RelGUID'], previous_games[i]['tTGUID']]),
                    ...r['TuDeel'].map(p => [p['RelGUID'], previous_games[i]['tUGUID']]),
                ]));
            const all_gebeurtenissen = gebeurtenis_data.flatMap(g => g['GebNis']).filter(g => g['GebStatus'] === 10);

            const on_court_plus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_court_minus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_bench_plus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));
            const on_bench_minus = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));

            const relguid_to_roster_entries = groupBy(all_players_with_duplicates, p => p.RelGUID);
            const relguid_to_most_common_number = Object.fromEntries(
                Object.entries(relguid_to_roster_entries).map(
                    ([relguid, entries]) => [relguid, most_common_value(entries.map(p => p.RugNr))])
                );

            const relguid_to_n_starts = Object.fromEntries(all_players_with_duplicates.map(p => [p.RelGUID, 0]));


            previous_games.forEach((game, i) => {
                const roster = rosters[i];
                const game_gebeurtenissen = gebeurtenis_data[i].GebNis;

                // count 5 starters
                const in_wissels = game_gebeurtenissen.filter(geb => geb.GebStatus === 10 && geb.GebType === 50 && geb.Text === 'in');
                const home_starters = in_wissels.filter(geb => geb.TofU === 'T').slice(0, 5).map(geb => geb.RelGUID);
                const away_starters = in_wissels.filter(geb => geb.TofU === 'U').slice(0, 5).map(geb => geb.RelGUID);
                home_starters.forEach(relguid => relguid_to_n_starts[relguid] += 1);
                away_starters.forEach(relguid => relguid_to_n_starts[relguid] += 1);

                const players_on_field = {T: [], U: []};
                const players_on_bench = {
                    T: roster.TtDeel.filter(player => player['Functie'] === 'S').map(player => player.RelGUID), 
                    U: roster.TuDeel.filter(player => player['Functie'] === 'S').map(player => player.RelGUID)
                };

                game_gebeurtenissen.forEach(geb => {
                    if (geb.GebStatus !== 10) {
                        return;
                    }
                    const tofu = geb.TofU;
                    const opp = tofu === 'T' ? 'U' : 'T';

                    if (geb['GebType'] === 50) {
                        // wissel
                        if (geb['Text'] === 'in') {
                            players_on_field[tofu].push(geb['RelGUID']);
                            players_on_bench[tofu] = players_on_bench[tofu].filter(v => v !== geb['RelGUID']);
                        } else if (geb['Text'] === 'uit') {
                            players_on_bench[tofu].push(geb['RelGUID']);
                            players_on_field[tofu] = players_on_field[tofu].filter(v => v !== geb['RelGUID']);
                        }
                    } else if (geb['GebType'] === 10) {
                        // score
                        const score = Number(geb['Text'].split(' ')[0]);
                        players_on_field[tofu].forEach(relguid => on_court_plus[relguid] += score);
                        players_on_bench[tofu].forEach(relguid => on_bench_plus[relguid] += score);
                        players_on_field[opp].forEach(relguid => on_court_minus[relguid] += score);
                        players_on_bench[opp].forEach(relguid => on_bench_minus[relguid] += score);
                    }
                });

            });

            const make_top_row = () => {
                const cells = [
                    "Naam",
                    "Nr",
                    // "Relguid",
                    "Birthdate",
                    "Team",
                    "Games",
                    "Starts",
                    "Minutes",
                    "Minutes per game",
                    "Points",
                    "Points per game",
                    "Points per 40'",
                    "High score",
                    "Threes",
                    "Threes per game",
                    "FTs",
                    "FTs per game",
                    "Fouls",
                    "Fouls per game",
                    "Non personal fouls",
                    "Plus",
                    "Minus",
                    "Plus minus",
                    "Plus per 40'",
                    "Minus per 40'",
                    "Plus minus per 40'",
                    "Team plus when benched",
                    "Team minus when benched",
                    "Team plus minus when benched",
                    "Team minutes when benched",
                    "Team plus per 40' when benched",
                    "Team minus per 40' when benched",
                    "Team plus minus per 40' when benched",
                    "Improvement in offense per 40' (on-off)",
                    "Improvement in defense per 40' (on-off)",
                    "Improvement in +/- per 40' (on-off)",
                    "Team ID",
                ].map(s => `<th>${s}</th>`).join('');

                return `<thead><tr>${cells}</tr></thead>`;
            }

            const data_for_player = (player) => {
                const relguid = player['RelGUID'];

                const player_games_indices = rosters.flatMap((roster, i) => 
                    [...roster.TtDeel, ...roster.TuDeel]
                    .filter(p => p['Functie'] == 'S')
                    .map(player => player['RelGUID'])
                    .includes(relguid) ? [i] : []
                );
                const player_previous_games = player_games_indices.map(i => previous_games[i]);
                const player_games_rosters = player_games_indices.map(i => rosters[i]);
                const player_games_gebeurtenis_data = player_games_indices.map(i => gebeurtenis_data[i]);

                const player_games_all_gebeurtenissen = player_games_gebeurtenis_data
                    .flatMap(g => g['GebNis'])
                    .filter(g => g['GebStatus'] === 10);

                const player_gebeurtenissen = player_games_all_gebeurtenissen.filter(g => g['RelGUID'] === relguid);
                const player_scores = player_gebeurtenissen.filter(g => g['GebType'] === 10);
                const player_fouten = player_gebeurtenissen.filter(g => g['GebType'] === 30);

                const gd = player.GebDat || "";
                const birthdate = `${gd.substr(6, 4)}-${gd.substr(3, 2)}-${gd.substr(0, 2)}`
                const n_games = player_previous_games.length;
                const minutes = gebeurtenis_data.map(gd => minutes_for_player(gd, relguid)).reduce((a, b) => a+b, 0);
                const minutes_per_game = minutes / n_games;

                const points = player_scores.map(g => Number(g.Text.split(' ')[0])).reduce((a, b) => a+b, 0);
                const points_per_game = points / n_games;
                const points_per_40 = points / minutes * 40 || 0.0;
                const high_score = Math.max(...
                    gebeurtenis_data.map(match_geb => match_geb.GebNis
                        .filter(g=> g['GebStatus'] === 10 && g['RelGUID'] === relguid && g['GebType'] === 10)
                        .map(g => Number(g.Text.split(' ')[0]))
                        .reduce((a, b) => a+b, 0)
                    )
                );

                const n_threes = player_scores.filter(g => g.Text[0] === "3").length;
                const n_threes_per_game = n_threes / n_games;
                const n_fts = player_scores.filter(g => g.Text[0] === "1").length;
                const n_fts_per_game = n_fts / n_games;

                const n_fouls = player_fouten.length;
                const n_fouls_per_game = n_fouls / n_games;
                const n_non_personal_fouls = player_fouten.filter(g => g.Text[0] !== 'P').length;

                const plus = on_court_plus[relguid];
                const minus = on_court_minus[relguid];
                const plus_minus = on_court_plus[relguid] - on_court_minus[relguid];

                const plus_per_40 = 40 * (plus / minutes || 0.0);
                const minus_per_40 = 40 * (minus / minutes || 0.0);
                const plus_minus_per_40 = 40 * (plus_minus / minutes || 0.0);

                const benched_plus = on_bench_plus[relguid];
                const benched_minus = on_bench_minus[relguid];
                const benched_plus_minus = on_bench_plus[relguid] - on_bench_minus[relguid];

                const benched_minutes = 40 * n_games - minutes;
                const benched_plus_per_40 = 40 * (benched_plus / benched_minutes || 0.0);
                const benched_minus_per_40 = 40 * (benched_minus / benched_minutes || 0.0);
                const benched_plus_minus_per_40 = 40 * (benched_plus_minus / benched_minutes || 0.0);

                const offensive_improvement = plus_per_40 - benched_plus_per_40;
                const defensive_improvement = -(minus_per_40 - benched_minus_per_40);
                const netto_improvement = plus_minus_per_40 - benched_plus_minus_per_40;

                const data = {
                    "Nr": relguid_to_most_common_number[relguid], // todo: most common number
                    "relguid": relguid,
                    "birthdate": birthdate,
                    "player": player['Naam'],
                    "team_relguid": relguid_to_teamid[relguid],
                    "teamnaam": relguid_to_teamnaam[relguid],
                    "n_games": n_games,
                    "n_starts": relguid_to_n_starts[relguid],
                    "minutes": minutes,
                    "minutes_per_game": minutes_per_game,
                    "points": points,
                    "points_per_game": points_per_game,
                    "points_per_40": points_per_40,
                    "high_score": high_score,
                    "n_threes": n_threes,
                    "n_threes_per_game": n_threes_per_game,
                    "n_fts": n_fts,
                    "n_fts_per_game": n_fts_per_game,
                    "n_fouls": n_fouls,
                    "n_fouls_per_game": n_fouls_per_game,
                    "n_non_personal_fouls": n_non_personal_fouls,
                    "plus": plus,
                    "minus": minus,
                    "plus_minus": plus_minus,
                    "plus_per_40": plus_per_40,
                    "minus_per_40": minus_per_40,
                    "plus_minus_per_40": plus_minus_per_40,
                    "benched_plus": benched_plus,
                    "benched_minus": benched_minus,
                    "benched_plus_minus": benched_plus_minus,
                    "benched_minutes": benched_minutes,
                    "benched_plus_per_40": benched_plus_per_40,
                    "benched_minus_per_40": benched_minus_per_40,
                    "benched_plus_minus_per_40": benched_plus_minus_per_40,
                    "offensive_improvement": offensive_improvement,
                    "defensive_improvement": defensive_improvement,
                    "netto_improvement": netto_improvement,
               };

               return data;
            }

            const row_from_data = (data) => {
                const teamname = shorten_teamname(data.teamnaam).replaceAll(' ', '&nbsp;')
                const cells = [
                    td(data.player.replaceAll(' ', '&nbsp;')),
                    td(data.Nr, 'right'),
                    // data.relguid,
                    td(data.birthdate),
                    td(a(`team.html?team=${data.team_relguid}`, teamname)),
                    td(data.n_games, 'right'),
                    td(data.n_starts, 'right'),
                    td(data.minutes.toFixed(1), 'right'),
                    td(data.minutes_per_game.toFixed(1), 'right'),
                    td(data.points, 'right'),
                    td(data.points_per_game.toFixed(1), 'right'),
                    td(data.points_per_40.toFixed(1), 'right'),
                    td(data.high_score, 'right'),
                    td(data.n_threes, 'right'),
                    td(data.n_threes_per_game.toFixed(1), 'right'),
                    td(data.n_fts, 'right'),
                    td(data.n_fts_per_game.toFixed(1), 'right'),
                    td(data.n_fouls, 'right'),
                    td(data.n_fouls_per_game.toFixed(1), 'right'),
                    td(data.n_non_personal_fouls, 'right'),
                    td(data.plus, 'right'),
                    td(data.minus, 'right'),
                    td(data.plus_minus, 'right'),
                    td(data.plus_per_40.toFixed(1), 'right'),
                    td(data.minus_per_40.toFixed(1), 'right'),
                    td(data.plus_minus_per_40.toFixed(1), 'right'),
                    td(data.benched_plus, 'right'),
                    td(data.benched_minus, 'right'),
                    td(data.benched_plus_minus, 'right'),
                    td(data.benched_minutes.toFixed(1), 'right'),
                    td(data.benched_plus_per_40.toFixed(1), 'right'),
                    td(data.benched_minus_per_40.toFixed(1), 'right'),
                    td(data.benched_plus_minus_per_40.toFixed(1), 'right'),
                    td(data.offensive_improvement.toFixed(2), 'right'),
                    td(data.defensive_improvement.toFixed(2), 'right'),
                    td(data.netto_improvement.toFixed(2), 'right'),
                    td(encodeURIComponent(data.team_relguid), 'teamid'),
               ];

                const joined_string = [
                    '<tr>', 
                    ...cells,
                    '</tr>'
                ].join('');

                return joined_string;

            }

            const datas = Object.values(relguid_to_player).filter(x => !x.RelGUID.startsWith('NA')).map(data_for_player);
            const rows = [
                make_top_row(),
                ...datas.map(row_from_data),
            ];

            document.getElementById('players_table').innerHTML = rows.join('');

            window.player_table = new DataTable("#players_table", {
                paging: false,
                fixedHeader: true,
                scrollX: true,
                fixedColumns: true,
            });

            return datas;
        }
        
        function hover_text_for_player(player, more_lines) {
            return [
                `${player.Nr} ${player.player}`, 
                shorten_teamname_more(player.teamnaam),
                `${player.minutes.toFixed(1)}' in ${player.n_games} games (${player.minutes_per_game.toFixed(1)}mpg)`,
                ...more_lines ? more_lines : [],
            ].join('<br>');
        }

        function marker_size_for_player(player) {
            return 5 * Math.sqrt(player.minutes)
        }

        function fix_marker_sizes(traces) {
            const total = traces.flatMap(trace => trace.marker.size).reduce(sum, 0);
            const n = traces.filter(trace=>trace.opacity > 0.1).length + 1;
            const meansize = total / n;
            // console.log(total, n, meansize)
            // debugger;
            traces.forEach(trace => trace.marker.size = trace.marker.size.map(s => s * 5000 / total));
        }

        function make_offense_defense_plot(selected_player_datas) {
            const selected_relguids = new Set(selected_player_datas.map(p => p.relguid));

            const trace_for_player = (player) => ({
                x: player.minutes ? [/* player.benched_plus_per_40 , */ player.plus_per_40] : [],
                y: player.minutes ? [/* player.benched_minus_per_40, */ player.minus_per_40] : [],
                type: 'scatter',
                text: hover_text_for_player(player, [
                    `${shorten_teamname_more(player.teamnaam)} scored ${player.plus_per_40.toFixed(1)} points per 40' when ${player.player.split(/\b/)[0]} was playing`,
                    `${shorten_teamname_more(player.teamnaam)} conceded ${player.minus_per_40.toFixed(1)} points per 40' when ${player.player.split(/\b/)[0]} was playing`,
                ]),
                marker: {
                    symbol: [
                        // "none", 
                        'circle'
                    ],
                    size: [
                        // 0, 
                        marker_size_for_player(player)
                    ],
                    color: team_guid_to_colour[player.team_relguid],
                    opacity: selected_relguids.has(player.relguid) ? 1 : 0.1,
                },
                line: {
                    width: player.minutes ? 1 : 0,
                    color: team_guid_to_colour[player.team_relguid],
                    opacity: selected_relguids.has(player.relguid) ? 1 : 0.1,
                },
                opacity: selected_relguids.has(player.relguid) ? 1 : 0.1,
                hoverinfo: selected_relguids.has(player.relguid) ? 'text' : 'none',
            });

            const traces = player_datas.map(trace_for_player);
            fix_marker_sizes(traces);
            if (filtered_data_is_of_one_team(selected_player_datas)){
                traces.push(...initials_on_data(selected_player_datas, trace_for_player));
            }

            const layout = {
                title: "Plus &amp; minus per 40 minutes",
                xaxis: {
                    title: "Plus per 40 minutes played",
                },
                yaxis: {
                    title: "Minus per 40 minutes played",
                    scaleanchor: "x", 
                    autorange: 'reversed',
                },
                annotations: corner_annotations,
                // dragmode: "pan",
                showlegend: false,
            }
            window.offense_defense_plot = Plotly.newPlot('offense_defense_plot', traces, layout, {scrollZoom: true});
        }

        function make_netto_improvement_plot(selected_player_datas) {
            const selected_relguids = new Set(selected_player_datas.map(p => p.relguid));

            const trace_for_player = (player) => ({
                x: player.minutes ? [player.plus_minus_per_40] : [],
                y: player.minutes ? [player.benched_plus_minus_per_40] : [],
                type: 'scatter',
                text: hover_text_for_player(player, [
                    `${shorten_teamname_more(player.teamnaam)} is ${plus_sign(player.plus_minus)}${player.plus_minus} in the ${(player.minutes || 0.0).toFixed(1)}' when ${player.player.split(/\b/)[0]} was playing`,
                    `${shorten_teamname_more(player.teamnaam)} is ${plus_sign(player.benched_plus_minus)}${player.benched_plus_minus} in the ${(player.benched_minutes || 0.0).toFixed(1)}' when ${player.player.split(/\b/)[0]} was benched`,
                ]),
                marker: {
                    symbol: ["none", 'circle'],
                    size: [marker_size_for_player(player)],
                    color: team_guid_to_colour[player.team_relguid],
                    opacity: selected_relguids.has(player.relguid) ? 1 : 0.1,
                },
                line: {
                    width: player.minutes ? 1 : 0,
                },
                hoverinfo: selected_relguids.has(player.relguid) ? 'text' : 'none',
            });
            
            const traces = player_datas.map(trace_for_player);
            fix_marker_sizes(traces);

            if (filtered_data_is_of_one_team(selected_player_datas)){
                traces.push(...initials_on_data(selected_player_datas, trace_for_player));
            }

            const annotations = [
                {
                    ..._left_annotation,
                    ..._top_annotation,
                    text: '(Players rostered in losses)',
                }, {
                    ..._hmid_annotation,
                    ..._top_annotation,
                    text: '(Teammates are worse than opponents)',
                }, {
                    ..._right_annotation,
                    ..._top_annotation,
                    text: '(Team plays better with them on court)',
                }, {
                    ..._left_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Players worse than their opponents)',
                }, {
                    ..._right_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Players better than their opponents)',
                }, {
                    ..._left_annotation,
                    ..._bottom_annotation,
                    text: '(Team plays better with them benched)',
                }, {
                    ..._hmid_annotation,
                    ..._bottom_annotation,
                    text: '(Teammates are better than opponents)',
                }, {
                    ..._right_annotation,
                    ..._bottom_annotation,
                    text: '(Players rostered in wins)',
                }
            ].map(x => ({..._absolute_annotation, ...x}));

            const layout = {
                title: "Difference in +/- per 40' between when player is benched and when playing",
                xaxis: {
                    title: "+/- per 40 minutes on court",
                },
                yaxis: {
                    title: "Team +/- per 40 minutes when benched",
                    scaleanchor: "x", 
                    autorange: 'reversed',
                },
                annotations: annotations,
                // dragmode: "pan",
                showlegend: false,
            }
            window.netto_improvement_plot = Plotly.newPlot('netto_improvement_plot', traces, layout, {scrollZoom: true});
        }

        function make_usage_plot(selected_player_datas) {
            const selected_relguids = new Set(selected_player_datas.map(p => p.relguid));

            const trace_for_player = (player) => ({
                x: [player.plus_per_40],
                y: [player.points_per_40],
                type: 'scatter',
                text: hover_text_for_player(player, [
                    `${player.player.split(/\b/)[0]} scored ${player.points} points in ${player.minutes.toFixed(1)} minutes (= ${player.points_per_40.toFixed(1)} / 40')`,
                    `${shorten_teamname_more(player.teamnaam)} scored ${player.plus} points when ${player.player.split(/\b/)[0]} was playing`,
                    `${player.player.split(/\b/)[0]} scored ${(player.points_per_40 / player.plus_per_40 * 100).toFixed(1)}% of ${shorten_teamname_more(player.teamnaam)}'s points when playing`,
                ]),
                marker: {
                    symbol: 'circle',
                    size: [marker_size_for_player(player)],
                    color: team_guid_to_colour[player.team_relguid],
                    opacity: selected_relguids.has(player.relguid) ? 1 : 0.1,
                },
                line: {
                    width: player.minutes ? 1 : 0,
                },
                hoverinfo: selected_relguids.has(player.relguid) ? 'text' : 'none',
            });
            const player_dots = player_datas.map(trace_for_player);
            fix_marker_sizes(player_dots);

            const max_x = Math.max(...player_dots.map(t => t.x[0])) * 1.1;
            const max_y = Math.max(...player_dots.map(t => t.y[0])) * 1.1;

            const diagonals = (
                Array(10)
                .fill()
                .map((_, i) => i * 10 + 10)
                .map(pct => ({
                    x: [0, Math.min(max_x, max_y / pct * 100)],
                    y: [0, Math.min(max_y, max_x * pct / 100)],
                    text: ['', pct < 50 || pct % 20 === 0 ? `${pct}%` : ''],
                    textposition: 'top',
                    mode: 'lines+text',
                    line: {
                        color: 'lightgrey',
                        width: 1,
                        dash: "dash",
                    },
                    hoverinfo: 'none',
                    textfont: {
                        color: 'black',
                    },
                    class: 'diagonals',
                }))
            );

            const traces = [...diagonals, ...player_dots,];

            if (filtered_data_is_of_one_team(selected_player_datas)){
                traces.push(...initials_on_data(selected_player_datas, trace_for_player));
            }

            const layout = {
                title: "Scoring sources: points stake when on court",
                xaxis: {
                    title: "Plus per 40 minutes",
                },
                yaxis: {
                    title: "Points per 40 minutes",
                },
                annotations: [{
                    x: max_y / (0.5),
                    y: max_y,
                    xref: 'x',
                    yref: 'y',
                    text: 'Players who score 50% of the team\'s points when they are playing',
                    showarrow: true,
                    align: 'center',
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: 'black',
                    ax: 20,
                    ay: -30,
                    bgcolor: 'white',
                }],
                // dragmode: "pan",
                showlegend: false,
            }
            window.netto_improvement_plot = Plotly.newPlot('usage_plot', traces, layout, {scrollZoom: true});
        }

        function filtered_data_is_of_one_team(player_datas) {
            for (var i = 1; i < player_datas.length; i++) {
                if (player_datas[i].team_relguid !== player_datas[i-1].team_relguid) {
                    return false;
                }
            }
            return true;
        }

        function initials_on_data(selected_player_datas, trace_function) {
            const selected_player_traces = selected_player_datas.map(trace_function);
            return selected_player_datas.map((player, i) => ({
                x: selected_player_traces[i].x,
                y: selected_player_traces[i].y,
                mode: 'text',
                text: player.player.split(/\s/).map(part => part[0]).join(''), // player.Nr,
                hoverinfo: 'none',

                textfont: {
                    color: 'black',//'white',
                },
            }));
        }

        function make_offense_defense_difference_plot(selected_player_datas) {
            const selected_relguids = new Set(selected_player_datas.map(p => p.relguid));
            const trace_for_player = (player) => ({
                x: [player.offensive_improvement],
                y: [player.defensive_improvement],
                type: 'scatter',
                text: hover_text_for_player(player, [
                    '',
                    `${shorten_teamname_more(player.teamnaam)} scored ${player.plus_per_40.toFixed(1)} points per 40' when ${player.player.split(/\b/)[0]} was playing (${player.plus} points in ${player.minutes.toFixed(1)}')`,
                    `${shorten_teamname_more(player.teamnaam)} scored ${player.benched_plus_per_40.toFixed(1)} points per 40' when ${player.player.split(/\b/)[0]} is benched (${player.benched_plus} points in ${player.benched_minutes.toFixed(1)}')`,
                    `${shorten_teamname_more(player.teamnaam)} scored ${Math.abs(player.offensive_improvement.toFixed(1))} points per 40' <i>${player.offensive_improvement > 0 ? "more" : "less"}</i> when ${player.player.split(/\b/)[0]} was playing`,
                    '',
                    `${shorten_teamname_more(player.teamnaam)} conceded ${player.minus_per_40.toFixed(1)} points per 40' when ${player.player.split(/\b/)[0]} was playing (${player.minus} points in ${player.minutes.toFixed(1)}')`,
                    `${shorten_teamname_more(player.teamnaam)} conceded ${player.benched_minus_per_40.toFixed(1)} points per 40' when ${player.player.split(/\b/)[0]} is benched (${player.benched_minus} points in ${player.benched_minutes.toFixed(1)}')`,
                    `${shorten_teamname_more(player.teamnaam)} conceded ${Math.abs(player.defensive_improvement.toFixed(1))} points per 40' <i>${player.defensive_improvement < 0 ? "more" : "less"}</i> when ${player.player.split(/\b/)[0]} was playing`,
                ]),
                marker: {
                    symbol: ["none", 'circle'],
                    size: [marker_size_for_player(player)],
                    color: team_guid_to_colour[player.team_relguid],
                    opacity: selected_relguids.has(player.relguid) ? 1 : 0.1,
                },
                line: {
                    width: player.minutes ? 1 : 0,
                },
                hoverinfo: selected_relguids.has(player.relguid) ? 'text' : 'none',
            });
            const traces = player_datas.map(trace_for_player);
            fix_marker_sizes(traces);

            if (filtered_data_is_of_one_team(selected_player_datas)){
                traces.push(...initials_on_data(selected_player_datas, trace_for_player));
            }
            
            const annotations = [
                {
                    ..._left_annotation,
                    ..._top_annotation,
                    text: '(Nobody scored when they play)',
                }, {
                    ..._hmid_annotation,
                    ..._top_annotation,
                    text: '(Team conceded less when they play)',
                }, {
                    ..._right_annotation,
                    ..._top_annotation,
                    text: '(Team plays better with them on court)',
                }, {
                    ..._left_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Team scored less when they play)',
                }, {
                    ..._right_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Team scored more when they play)',
                }, {
                    ..._left_annotation,
                    ..._bottom_annotation,
                    text: '(Team plays better with them benched)',
                }, {
                    ..._hmid_annotation,
                    ..._bottom_annotation,
                    text: '(Team conceded more when they play)',
                }, {
                    ..._right_annotation,
                    ..._bottom_annotation,
                    text: '(Both teams score when they play)',
                }
            ].map(x => ({..._absolute_annotation, ...x}));


            const layout = {
                title: "Improvement in <i>plus per 40'</i> and <i>minus per 40'</i> of team when player was playing vs. benched",
                xaxis: {
                    title: "Improvement in <i>plus per 40'</i> of team when player was playing vs. benched (\"Offensive improvement\")",
                },
                yaxis: {
                    title: "Improvement in <i>minus per 40'</i> of team when player was playing vs. benched (\"Defensive improvement\")",
                    scaleanchor: "x", 
                    // autorange: 'reversed',
                },
                annotations: annotations,
                // dragmode: "pan",
                showlegend: false,
            }
            window.netto_improvement_plot = Plotly.newPlot('offense_defense_difference_plot', traces, layout, {scrollZoom: true});
        }

        function make_shooting_plot(selected_player_datas) {
            const selected_relguids = new Set(selected_player_datas.map(p => p.relguid));

            const trace_for_player = (player) => ({
                x: player.minutes ? [(player.points_per_game - (player.n_threes_per_game * 3) - player.n_fts_per_game) / 2] : [],
                y: player.minutes ? [player.n_threes_per_game] : [],
                type: 'scatter',
                text: hover_text_for_player(
                    player, [
                        `${player.n_fts_per_game.toFixed(1)} fts pg`,
                        `${((player.points_per_game - player.n_threes_per_game * 3 - player.n_fts_per_game) / 2).toFixed(1)} twos pg`,
                        `${player.n_threes_per_game.toFixed(1)} threes pg`,
                        `${player.points_per_game.toFixed(1)} ppg`
                    ]
                ),
                marker: {
                    symbol: 'circle',
                    size: [marker_size_for_player(player)],
                    color: team_guid_to_colour[player.team_relguid],
                    opacity: selected_relguids.has(player.relguid) ? 1 : 0.1,
                },
                line: {
                    width: player.minutes ? 1 : 0,
                },
                hoverinfo: selected_relguids.has(player.relguid) ? 'text' : 'none',
            });
            
            const traces = player_datas.map(trace_for_player);
            fix_marker_sizes(traces);

            if (filtered_data_is_of_one_team(selected_player_datas)){
                traces.push(...initials_on_data(selected_player_datas, trace_for_player));
            }

            const annotations = [
                {
                    ..._left_annotation,
                    ..._top_annotation,
                    text: '(Only score three-pointers)',
                }, {
                    ..._hmid_annotation,
                    ..._top_annotation,
                    text: '(Score many three-pointers)',
                }, {
                    ..._right_annotation,
                    ..._top_annotation,
                    text: '(Universal scorers)',
                }, {
                    ..._left_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Never score two-pointers)',
                }, {
                    ..._right_annotation,
                    ..._vmid_annotation,
                    textangle: -90,
                    text: '(Score many two-pointers)',
                }, {
                    ..._left_annotation,
                    ..._bottom_annotation,
                    text: '(Never score)',
                }, {
                    ..._hmid_annotation,
                    ..._bottom_annotation,
                    text: '(Never score three-pointers)',
                }, {
                    ..._right_annotation,
                    ..._bottom_annotation,
                    text: '(Only score two-pointers)',
                }
            ].map(x => ({..._absolute_annotation, ...x}));

            const layout = {
                title: "Shooters",
                xaxis: {
                    title: "Two-pointers per game",
                    // type: 'log',  // Keep linear: show people with 0 two-pointers
                },
                yaxis: {
                    title: "Three-pointers per game",
                    // type: 'log', / Keep linear: show people with 0 three-pointers
                },
                annotations: annotations,
                // dragmode: "pan",
                showlegend: false,
            }
            window.shooting_plot = Plotly.newPlot('shooting_plot', traces, layout, {scrollZoom: true});
        }

        function make_plots(selected_player_datas) {
            make_offense_defense_plot(selected_player_datas);
            make_netto_improvement_plot(selected_player_datas);
            make_usage_plot(selected_player_datas);
            make_offense_defense_difference_plot(selected_player_datas);
            make_shooting_plot(selected_player_datas);
        }

        function connect_table_search_to_plots() {
            window.player_table.on('search', function (event, table_state) {
                const value_before_wait = document.querySelector('input[type=search').value;
                window.setTimeout(
                    () => {
                        const value_after_wait = document.querySelector('input[type=search').value;
                        if (value_before_wait !== value_after_wait) {
                            return;
                        }
                        make_plots(table_state.aiDisplay.map(i => player_datas[i]));
                    },
                    1000
                )
            });
        }

        addEventListener('load', async () => {
            const poule_guid = (new URLSearchParams(window.location.search)).get('pouleGUID');
            document.body.classList.add('loading');

            all_games = fetch_poule_games(poule_guid);

            all_games = await all_games;
            g = all_games[0];

            played_games = all_games.filter(g => g['uitslag']);

            played_guids = played_games.map(g=> g.guid);

            const all_team_guids = [...new Set(all_games.map(g => g.tTGUID))];
            n_teams = all_team_guids.length;

            team_guid_to_colour = Object.fromEntries(all_team_guids.map((g, i) => [g, 
                `hsl(${i * 360 / n_teams}, ${i % 2 ? 0.4 : 0.8}, .5)`,
            ]));

            rosters = fetch_team_rosters_for_games(played_games);
            gebeurtenis_data = fetch_gebeurtenis_data_for_games(played_games);

            rosters = await rosters;
            gebeurtenis_data = await gebeurtenis_data;
            // team_guid_to_colours = await team_guid_to_colours;

            gebeurtenis_data.forEach(gdi => {
                gdi.GebNis = add_fake_minute_to_gebnis(gdi.GebNis);
                gdi.GebNis = add_detailed_minute_to_gebnis(gdi.GebNis);
            });
            
            document.querySelector('h1').innerText = "Spelers in " + all_games[0]['pouleNaam'];

            window.player_datas = make_players_table(played_games, rosters, gebeurtenis_data);

            make_plots(player_datas);

            connect_table_search_to_plots();

            const search_param = new URLSearchParams(window.location.search).get('search');
            if (search_param) {
                window.player_table.search(search_param).draw();
            }

            document.body.classList.remove('loading');
        });

    </script>
</body>
</html>