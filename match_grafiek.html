<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Laden...</title>

    <script src="itertools.js"></script>
    <script src="gebeurtenis_data.js"></script>
    <script src="fetching.js"></script>
    <script src="vis.js"></script>
    <script src="common.js"></script>
    <script src="libs/lz-string.min.js"></script>
    <script src="libs/plotly-2.9.0.min.js"></script>

    <link href="match_grafiek.css" rel="stylesheet" type="text/css">
</head>
<body>
<h1>Laden...</h1>
<h2 id="reeks"></h2>
<p id="date"></p>

<div id='general_stats'>
    <table id='quarters'></table>

</div>
<div id='plot'></div>

<div id='box_scores'>
    <table class='stats home booktabs w_totals'></table>
    <table class='stats away booktabs w_totals'></table>
</div>

<div>
    <div id="other_stats">
        <img class="h" src="">
        <img class="a" src="">
        <div class="largest_lead h"></div>
        <div class="largest_lead name">Grootste voorsprong</div>
        <div class="largest_lead a"></div>
        <div class="largest_run h"></div>
        <div class="largest_run name">Grootste streak</div></td>
        <div class="largest_run a"></div>
        <div class="n_fouls h"></div>
        <div class="n_fouls name">Fouten</div></td>
        <div class="n_fouls a"></div>
        <div class="free_throws h"></div>
        <div class="free_throws name">Vrijworpen</div></td>
        <div class="free_throws a"></div>
        <div class="time_led h"></div>
        <div class="time_led name" style="visibility: hidden">Tijd aan de leiding</div>
        <div class="time_led a"></div>
<!--        <div class="both">Gelijkstanden</div>-->
        <!--    <tr id="leader_changes">-->
        <!--    <div colspan="3">Lead changes</div>-->
    </div>
</div>
</body>

<script type="text/javascript">
	async function load_data(game_id) {
		let roster = fetch_rosters(game_id);
		let gebeurtenis_data = fetch_gebeurtenis_data(game_id);
        let poule_games = fetch_poule_games(game_id.substring(0, game_id.length - 2));

		window.game_id = game_id;
		window.gebeurtenis_data = await gebeurtenis_data;
		window.roster = await roster;
		window.poule_games = await poule_games;

		window.game = window.poule_games.find(game => game.guid === game_id);
	}


	async function make_graph() {
		let points_trace = {
			x: [0],
			y: [0],
			text: ['Start'],
			type: 'scatter',
			hoverinfo: 'text',
			showlegend: true,
			name: 'Home advantage'
		};
		let to_trace = {
			x: [],
			y: [],
			text: [],
			type: 'scatter',
			mode: 'markers',
			hoverinfo: 'text',
			marker: {color: 'black'},
			showlegend: true,
			name: 'Time-outs'
		}
		let fouls_trace = {
			x: [],
			y: [],
			text: [],
			type: 'scatter',
			mode: 'markers',
			hoverinfo: 'text',
			marker: {color: 'red'},
			showlegend: true,
			name: 'Fouls'
		}

		let geb_index_x = [];
		let last_y;

		const gebnis = add_detailed_minute_to_gebnis(gebeurtenis_data.GebNis);

		gebnis.forEach((geb, i) => {
			let team_str = geb.TofU === 'T' ? 'Home' : 'Away'

			if (geb.GebStatus !== 10) {
				return;
			}

			const x = geb.detailed_minute;
			last_y = points_trace.y[points_trace.y.length - 1]

			const player = roster.TuDeel.concat(roster.TtDeel).find(player => player.RelGUID == geb.RelGUID)

			if (geb.GebType === 10) {
				const split = geb.Text.split(/\b/);
				const newdiff = split[2] - split[4];
				const text = `${team_str} score ${geb.Text}<br>${geb.RugNr} ${player.Naam}`;

				points_trace.x.push(x, x);
				points_trace.y.push(last_y, newdiff);
				points_trace.text.push(text, text);
			}

			if (geb.GebType === 20) {
				to_trace.x.push(x);
				to_trace.y.push(geb.TofU === 'T' ? .2 : -.2);
				to_trace.text.push(`Time out<br>${team_str} team`);
			}

			if (geb.GebType === 30) {
				fouls_trace.x.push(x);

				fouls_trace.y.push(last_y + (geb.TofU === 'T' ? .2 : -.2));
				fouls_trace.text.push(`${team_str} foul "${geb.Text}"<br>${geb.RugNr} ${player.Naam}`);
			}

			geb_index_x.push({
				geb_index: geb.Index,
				x: x
			});
		})

		if (points_trace.x[points_trace.x.length - 1] < 40) {
			points_trace.x.push(40);
			points_trace.y.push(last_y);
			points_trace.text.push('');
		}


		let layout = {
			xaxis: {
				title: 'Minuut',
				// dtick: 1,
				fixedrange: true,
			},
			yaxis: {
				title: `Voorsprong ${shorten_teamname(game.tTNaam)}`,
				fixedrange: true,
			},
			margin: {
				l: window.innerWidth * .05,
				r: 10,
				t: 10,
			},
			legend: {
				x: 0.99,
				xanchor: 'right',
				y: last_y < 0 ? 1 : 0
			},
			font: {
				family: 'Georgia, Palatino, serif',
			}
		};
		const config = {
			responsive: true,
			// displayModeBar: false,
			displaylogo: false,
		}

		window.plot = await Plotly.newPlot('plot', [points_trace, to_trace, fouls_trace], layout, config);

		plot.on('plotly_hover', function (data) {
			console.log(data)
			// debugger;
		});
	}

	const td = content => `<td>${content}</td>`;

	function make_title() {
		const record_for_team = (guid) => {
			const n_home_wins_in_filtered_poule_games = (filtered_poule_games) => {
				return filtered_poule_games.filter(pg =>pg.uitslag.substring(0, 3) - pg.uitslag.substring(4, 7) > 0).length
			}

			const home_games = poule_games.filter(pg => pg.tTGUID == guid && pg.uitslag);
			const away_games = poule_games.filter(pg => pg.tUGUID == guid && pg.uitslag);

			const home_wins = n_home_wins_in_filtered_poule_games(home_games);
            const away_losses = n_home_wins_in_filtered_poule_games(away_games);
			const home_losses = home_games.length - home_wins;
			const away_wins = away_games.length - away_losses
			return [
				home_wins + away_wins,
                home_losses + away_losses
            ]
        }

		const home_record = record_for_team(game.tTGUID);
		const away_record = record_for_team(game.tUGUID);

		let h1 = document.querySelector('body > h1');
		h1.innerHTML = (
			`${game.tTNaam} (${home_record.join('-')})` +
			' - ' +
			`${game.tUNaam} (${away_record.join('-')})`
		);

		document.title = `${game.tTNaam} - ${game.tUNaam}`

		document.querySelector('h2#reeks').innerText = game.pouleNaam;

		document.querySelector('p#date').innerHTML = [
			Number.parseInt(game.datumString.substring(0, 2)),
			['', 'januari', 'februari', 'maart', 'april', 'mei', 'juni', 'juli', 'augustus', 'september', 'oktober', 'november', 'december'][Number.parseInt(game.datumString.substring(3, 5))],
			' ' + Number.parseInt(game.datumString.substring(6, 10)),
            '<br>',
			game.accNaam
        ].join(' ')
	}

	function make_quarters_table() {
		let quarters = document.querySelector('table#quarters');
		let periodenames = (
			gebeurtenis_data.GebNis
				.filter(geb => geb.GebStatus === 10)
				.filter(geb => geb.GebType === 40)
				.filter(geb => !geb.Text.includes('Balbezit'))
				.map(geb => geb.Text.split(' ').pop())
		);

		const td_points_in_periode = (periode, T_OR_U) => td(
			gebeurtenis_data.GebNis
				.filter(geb => geb.GebStatus === 10)
				.filter(geb => geb.Periode == periode)
				.filter(geb => geb.TofU === T_OR_U)
				.filter(geb => geb.GebType === 10)
				.map(geb => Number(geb.Text.split(' ')[0]))
				.reduce(((x, acc) => acc + Number(x)), 0)
		)

		quarters.innerHTML = (
			`<tr><td></td>${periodenames.map(td).join('')}<td>FT</td></tr>` +
			`<tr><td><a href='team.html?team=${game.tTGUID}'>${game.tTNaam}</a></td>` + periodenames.map(p => td_points_in_periode(p, 'T')).join('') + td(game.uitslag.split('-')[0]) + `</tr>` +
			`<tr><td><a href='team.html?team=${game.tUGUID}'>${game.tUNaam}</a></td>` + periodenames.map(p => td_points_in_periode(p, 'U')).join('') + td(game.uitslag.split('-')[1]) + `</tr>`
		);
	}

	async function make_team_tables() {
		const pm = gebeurtenis_data_to_plus_minus(gebeurtenis_data);

		[["home", roster.TtDeel], ["away", roster.TuDeel]].forEach(([c, teamroster]) => {
			const table = document.querySelector('table.stats.' + c);

			let sum_pts = 0;
			let sum_ft = 0;
			let sum_3 = 0;
			let sum_F = 0;
			let sum_pm = 0;
			let sum_min = 0;

			const row = document.createElement('tr');
			row.innerHTML = [
				'', '', 'pts', 'ft', '3', 'F', '+/-', 'min'
			].map(td).join('');
			table.appendChild(row)

			teamroster.forEach(player => {
				if (!player.Naam) {
					return
				}

				const this_player_gebs = (
					gebeurtenis_data.GebNis
						.filter(g => g.GebStatus === 10)
						.filter(g => g.RelGUID === player.RelGUID)
				);

				const scores = this_player_gebs.filter(g => g.GebType == 10);
				const score_1 = scores.filter(g => g.Text.startsWith('1 ')).length;
				const score_2 = scores.filter(g => g.Text.startsWith('2 ')).length;
				const score_3 = scores.filter(g => g.Text.startsWith('3 ')).length;
				const points_total = score_1 + 2 * score_2 + 3 * score_3;
				let minutes = minutes_for_player(gebeurtenis_data,  player.RelGUID);
				const minutes_str = Math.round(minutes);

				const fouls = this_player_gebs.filter(g => g.GebType == 30);
				let fouls_str = `${fouls.length}`
				const otherfouls = fouls.map(g => g.Text[0] === 'P' ? '' : g.Text[0]).join('');
				if (otherfouls) {
					fouls_str += `<sup>${otherfouls}</sup>`;
				}

				const row = document.createElement('tr');
				row.innerHTML = [
					player.RugNr,
					player.Naam,
					// '\'' + player.GebDat.substring(8, 10),
					points_total,
					score_1,
					score_3,
					fouls_str,
					pm[player.RelGUID] || '0',
					minutes_str
				].map(td).join('');

				table.appendChild(row);


				sum_pts += points_total;
				sum_ft += score_1;
				sum_3 += score_3;
				sum_F += fouls.length;
				sum_pm += pm[player.RelGUID] || 0;
				sum_min += minutes;
			});

			const bottomrow = document.createElement('tr');
			bottomrow.innerHTML = [
				'',
				'',
				// '\'' + player.GebDat.substring(8, 10),
				sum_pts,
				sum_ft,
				sum_3,
				sum_F,
				sum_pm,
				Math.round(sum_min)
			].map(td).join('');

			table.appendChild(bottomrow);

			table.style.display = 'inline';
		})
	}

	function make_other_stats() {

		// const ties = 1 + score_diffs.filter(l => l === 0).length

		const home_id = game.tTGUID.substring(0, 8);
		const away_id = game.tUGUID.substring(0, 8);

		document.querySelector('div#other_stats img.h').src = `https://vblcb.wisseq.eu/vbldata/organisatie/${home_id}_Small.jpg`;
		document.querySelector('div#other_stats img.a').src = `https://vblcb.wisseq.eu/vbldata/organisatie/${away_id}_Small.jpg`;

		const score_diffs = (
			gebeurtenis_data.GebNis
				.filter((geb) => (geb.GebStatus === 10) && (geb.GebType === 10))
				.map((geb) => geb.Text.split(/\b/))
				.map((split) => split[2] - split[4])
		);
		document.querySelector('div#other_stats div.largest_lead.h').innerHTML = Math.max(...score_diffs);
		document.querySelector('div#other_stats div.largest_lead.a').innerHTML = -Math.min(...score_diffs);

		const biggest_runs = (() => {
			const biggest_runs = {T: 0, U: 0};
			let current_running_team = '';
			let current_team_run = 0;

			gebeurtenis_data.GebNis.forEach((geb) => {
				if (geb.GebStatus !== 10) {
					return;
				}

				if (geb.GebType === 10) {
					if (current_running_team === geb.TofU) {
						current_team_run += Number.parseInt(geb.Text.split(/\b/)[0]);
					} else {
						current_team_run = Number.parseInt(geb.Text.split(/\b/)[0]);
					}
					biggest_runs[geb.TofU] = Math.max(biggest_runs[geb.TofU], current_team_run)

					current_running_team = geb.TofU;
				}
			});
			return biggest_runs;
		})();

		document.querySelector('div#other_stats div.largest_run.h').innerHTML = biggest_runs.T;
		document.querySelector('div#other_stats div.largest_run.a').innerHTML = biggest_runs.U;

		document.querySelector('div#other_stats div.n_fouls.h').innerHTML = gebeurtenis_data.GebNis
			.filter((geb) => (geb.GebStatus === 10) && (geb.GebType === 30) && (geb.TofU === 'T')).length;
		document.querySelector('div#other_stats div.n_fouls.a').innerHTML = gebeurtenis_data.GebNis
			.filter((geb) => (geb.GebStatus === 10) && (geb.GebType === 30) && (geb.TofU === 'U')).length;

		document.querySelector('div#other_stats div.free_throws.h').innerHTML = (
			gebeurtenis_data.GebNis
				.filter((geb) =>
                    (geb.GebStatus === 10) &&
                    (geb.GebType === 10) &&
                    (geb.TofU === 'T') &&
                    (geb.Text[0] === "1")
                ).length
			+ ' / ' +
			gebeurtenis_data.GebNis
				.filter((geb) =>
					(geb.GebStatus === 10) &&
					(geb.GebType === 30) &&
					(geb.TofU === 'U')
				)
                .map((geb) => Number.parseInt(geb.Text[1] || 0))
                .reduce(sum, 0)
        );
		document.querySelector('div#other_stats div.free_throws.a').innerHTML = (
			gebeurtenis_data.GebNis
				.filter((geb) =>
					(geb.GebStatus === 10) &&
					(geb.GebType === 10) &&
					(geb.TofU === 'U') &&
					(geb.Text[0] === "1")
				).length
			+ ' / ' +
			gebeurtenis_data.GebNis
				.filter((geb) =>
					(geb.GebStatus === 10) &&
					(geb.GebType === 30) &&
					(geb.TofU === 'T')
				)
				.map((geb) => Number.parseInt(geb.Text[1] || 0))
				.reduce(sum, 0)
		);

	}

	function redirect_if_team_unspecified() {
		const params = new URLSearchParams(window.location.search.substr(1));
		if (params.get('game_id')) {
			return params.get('game_id');
		}
		window.location.replace(window.location + '?game_id=BVBL21229120LIHSE31ADG')
	}


	(async () => {
		window.game_id = redirect_if_team_unspecified();
		await load_data(window.game_id);

		make_graph_promise = make_graph();
		make_sheets_promise = make_team_tables();

		make_title();
		make_quarters_table();
		make_other_stats();

		await make_graph_promise;

		// console.table(add_detailed_minute_to_gebnis(gebeurtenis_data.GebNis));

	})();

</script>
</html>