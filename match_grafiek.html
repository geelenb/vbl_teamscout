<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Laden...</title>
	<script src='https://cdn.plot.ly/plotly-2.9.0.min.js'></script>
    <script src="itertools.js"></script>
    <script src="gebeurtenis_data.js"></script>
    <script src="fetching.js"></script>
    <script src="vis.js"></script>
    <script src="common.js"></script>
    <script language="javascript" src="libs/lz-string.min.js"></script>

    <link rel="stylesheet" type="text/css" href="match_grafiek.css">
</head>
<body>
	<h1>Laden...</h1>
	<table id='quarters'></table>
	<div id='myDiv'></div>
	<div id='statsholder'>
		<table class='stats home'></table>
		<table class='stats away'></table>
	</div>
	<table id='gebeurtenissen'></table>
</body>

<script type="text/javascript">
	async function load_data(game_id) {
		let roster = fetch_rosters(game_id);
		let gebeurtenis_data = fetch_gebeurtenis_data(game_id);

		window.game_id = game_id;
		window.gebeurtenis_data = await gebeurtenis_data;
		window.roster = await roster;

		let poule = game_id.substring(0, game_id.length - 2);
		window.poule_games = await fetch_poule_games(poule);

		window.game = poule_games.find(game => game.guid === game_id);
	}


	async function make_graph() {
		let points_trace = {
			x: [0],
			y: [0],
			text: ['Start'],
			type: 'scatter',
			hoverinfo: 'text',
			showlegend: true,
			name: 'Home advantage'
		};
		let to_trace = {
			x: [],
			y: [],
			text : [],
			type: 'scatter',
  			mode: 'markers',
			hoverinfo: 'text',
			marker: {color: 'black'},
			showlegend: true,
			name: 'Time-outs'
		}
		let fouls_trace = {
			x: [],
			y: [],
			text : [],
			type: 'scatter',
  			mode: 'markers',
			hoverinfo: 'text',
			marker: {color: 'red'},
			showlegend: true,
			name: 'Fouls'
		}

		let geb_index_x = [];
		let last_y;

		for (i = 0; i < gebeurtenis_data.GebNis.length; i++) {
			const geb = gebeurtenis_data.GebNis[i];
			let team = geb.TofU === 'T' ? 'Home' : 'Away'

			if (geb.GebStatus !== 10) {
				continue;
			}

			const geb_this_minute = (
				gebeurtenis_data.GebNis
				.filter(lgeb => (lgeb.GebStatus === 10))
				.filter(lgeb => geb.Periode === lgeb.Periode)
				.filter(lgeb => geb.Minuut === lgeb.Minuut)	
				.filter(lgeb => !([50, 40].includes(lgeb.GebType))) // filter out periode start, substitutions
			);
			const index_in_this_minute = geb_this_minute.findIndex(lgeb => lgeb.Index === geb.Index);
			const x = (geb.Periode - 1) * 10 + (geb.Minuut - 1) + (0.5 + index_in_this_minute) / geb_this_minute.length;
			last_y = points_trace.y[points_trace.y.length - 1]

			const player = roster.TuDeel.concat(roster.TtDeel).find(player => player.RelGUID == geb.RelGUID)

			if (geb.GebType === 10) {
				const split = geb.Text.split(/\b/);
				const newdiff = split[2] - split[4];
				const text = `${team} score ${geb.Text}<br>${geb.RugNr} ${player.Naam}`;

				points_trace.x.push(x, x);
				points_trace.y.push(last_y, newdiff);
				points_trace.text.push(text, text);
			}

			if (geb.GebType === 20) {
				to_trace.x.push(x);
				to_trace.y.push(geb.TofU === 'T' ? .2 : -.2);
				to_trace.text.push(`Time out<br>${team} team`);
			}

			if (geb.GebType === 30) {
				fouls_trace.x.push(x);

				fouls_trace.y.push(last_y + (geb.TofU === 'T' ? .2 : -.2));
				fouls_trace.text.push(`${team} foul "${geb.Text}"<br>${geb.RugNr} ${player.Naam}`);
			}

			geb_index_x.push({
				geb_index: geb.Index,
				x: x
			});
		}

		if (points_trace.x[points_trace.x.length - 1] < 40) {
			points_trace.x.push(40);
			points_trace.y.push(last_y);
			points_trace.text.push('');
		}


		let layout = {
			xaxis: {
				title: 'Minuut',
				// dtick: 1,
				fixedrange: true,
			},
			yaxis: {
				title: `Voorsprong ${shorten_teamname(game.tTNaam)}`,
				fixedrange: true,
			},
			margin: {
				l: window.innerWidth * .05,
				r: 10,
				t: 10,
			},
			legend: {
				x: 0.03,
				xanchor: 'left',
				y: 1
			}
		};
		const config = {
			responsive: true,
			// displayModeBar: false,
			displaylogo: false,
		}

		window.plot = await Plotly.newPlot('myDiv', [points_trace, to_trace, fouls_trace], layout, config);

		plot.on('plotly_hover', function(data){
			console.log(data)
			// debugger;
		});
	}

	const td = content => `<td>${content}</td>`;

	function make_statics() {
		let h1 = document.querySelector('body > h1');
		h1.innerHTML = (
			`<a href='index.html?team=${game.tTGUID}'>${game.tTNaam}</a>` + 
			' - ' + 
			`<a href='index.html?team=${game.tUGUID}'>${game.tUNaam}</a>`
		);

		document.title = `${game.tTNaam} - ${game.tUNaam}`

		let quarters = document.querySelector('table#quarters');
		let periodenames = (
			gebeurtenis_data.GebNis
			.filter(geb => geb.GebStatus === 10)
			.filter(geb => geb.GebType === 40)
			.filter(geb => !geb.Text.includes('Balbezit'))
			.map(geb => geb.Text.split(' ').pop())
		);

		const td_points_in_periode = (periode, T_OR_U) => td(
			gebeurtenis_data.GebNis
			.filter(geb => geb.GebStatus === 10)
			.filter(geb => geb.Periode == periode)
			.filter(geb => geb.TofU === T_OR_U)
			.filter(geb => geb.GebType === 10)
			.map(geb => Number(geb.Text.split(' ')[0]))
			.reduce(((x, acc) => acc + Number(x)), 0)
		)

		quarters.innerHTML = (
			`<tr><td></td><td>FT</td>${periodenames.map(td).join('')}</tr>` + 
			`<tr>${td(game.tTNaam)} ${td(game.uitslag.split('-')[0])} ${ periodenames.map(p => td_points_in_periode(p, 'T')).join('') }</tr>` + 
			`<tr>${td(game.tUNaam)} ${td(game.uitslag.split('-')[1])} ${ periodenames.map(p => td_points_in_periode(p, 'U')).join('') }</tr>`
		);
	}
	
	async function make_sheets() {
		function geb_minute(geb) {
			const geb_this_minute = (
				gebeurtenis_data.GebNis
				.filter(lgeb => (lgeb.GebStatus === 10))
				.filter(lgeb => geb.Periode === lgeb.Periode)
				.filter(lgeb => geb.Minuut === lgeb.Minuut)	 // don't filter out periode start, substitutions here
			);
			const index_in_this_minute = geb_this_minute.findIndex(lgeb => lgeb.Index === geb.Index);
			return (geb.Periode - 1) * 10 + (geb.Minuut - 1) + (0.5 + index_in_this_minute) / geb_this_minute.length;
		}

		[["home", roster.TtDeel], ["away", roster.TuDeel]].forEach(([c, teamroster]) => {
			// debugger
			const table = document.querySelector('table.stats.' + c);

			const row = document.createElement('tr');
			row.innerHTML = [
				'', '', 'P', 'ft', '3', 'F', '+/-', 'min'
			].map(td).join('');
			table.appendChild(row)

			teamroster.forEach(player => {
				if (!player.Naam) {
					return
				}

				const this_player_gebs = (
					gebeurtenis_data.GebNis
					.filter(g => g.GebStatus === 10)
					.filter(g => g.RelGUID === player.RelGUID)
				);

				const scores = this_player_gebs.filter(g => g.GebType == 10);
				const score_1 = scores.filter(g => g.Text.startsWith('1 ')).length;
				const score_2 = scores.filter(g => g.Text.startsWith('2 ')).length;
				const score_3 = scores.filter(g => g.Text.startsWith('3 ')).length;
				const points_total = score_1 + 2 * score_2 + 3 * score_3;

				let plusminus = 0;
				let on = false;
				let minutes = 0;
				for (let i = 0; i < gebeurtenis_data.GebNis.length; i++) {
					const geb = gebeurtenis_data.GebNis[i];
					if (geb.GebStatus !== 10) {
						continue;
					}
					if (geb.GebType === 10) {
						if (on) {
							plusminus += Number(geb.Text.split(/\b/)[0]) * (
								((geb.TofU === 'T') === (c === 'home')) ? 1 : -1
							);
						}
					}

					if (geb.Text === 'in' && geb.RelGUID === player.RelGUID) {
						on = true;
						minutes -= geb_minute(geb);
					}

					if (geb.Text === 'uit' && geb.RelGUID === player.RelGUID) {
						on = false;
						minutes += geb_minute(geb);
					}
				}
				if (on) {
					const copy = [].concat(gebeurtenis_data.GebNis)
					copy.reverse();
					const last_geb = copy.find(geb => geb.Periode < 99);
					// console.log(geb_minute(last_geb))
					// debugger;
					minutes += geb_minute(last_geb);
				}
				minutes = Math.round(minutes);

				const fouls = this_player_gebs.filter(g => g.GebType == 30);
				let fouls_str = `${fouls.length}`
				const otherfouls = fouls.map(g => g.Text[0] === 'P' ? '' : g.Text[0]).join('');
				if (otherfouls) {
					fouls_str += `<sup>${otherfouls}</sup>`;
				}
			    
				const row = document.createElement('tr');
				row.innerHTML = [
					player.RugNr,
					player.Naam,
					// '\'' + player.GebDat.substring(8, 10),
					points_total,
					score_1,
					score_3,
					fouls_str,
					plusminus,
					minutes
				].map(td).join('');

				table.appendChild(row);
			});

			table.style.display = 'inline';
		})
	}

	function make_gebeurtenissen() {
		const table = document.querySelector('table#gebeurtenissen')

	}

    function redirect_if_team_unspecified() {
        const params = new URLSearchParams(window.location.search.substr(1));
        if (params.get('game_id')) {
            return params.get('game_id');
        }
        window.location.replace(window.location + '?game_id=BVBL21229120LIHSE31ADG')
    }


	(async () => {
		window.game_id = redirect_if_team_unspecified();
		await load_data(window.game_id);

		make_graph_promise = make_graph();
		make_sheets_promise = make_sheets();

		make_statics();

		await make_graph_promise;
	})();

	function downloadMyElement() {
	   var MyElement=document.body.outerHTML;
        var filename = "MyElement.html";
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(MyElement));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

</script>
</html>