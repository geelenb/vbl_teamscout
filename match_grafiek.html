<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Laden...</title>
	<script src='https://cdn.plot.ly/plotly-2.9.0.min.js'></script>
    <script src="itertools.js"></script>
    <script src="gebeurtenis_data.js"></script>
    <script src="fetching.js"></script>
    <script src="vis.js"></script>
    <script src="common.js"></script>
</head>
<body style="background: #333">
	<h1>Laden...</h1>
	<table id='quarters'></table>
	<div id='myDiv'></div>
	<table id='stats'></table>
	<table id='gebeurtenissen'></table>
</body>

<script type="text/javascript">
	async function load_data(game_id) {
		let roster = fetch_rosters(game_id);
		let gebeurtenis_data = fetch_gebeurtenis_data(game_id);

		window.game_id = game_id;
		window.gebeurtenis_data = await gebeurtenis_data;
		window.roster = await roster;

		let poule = game_id.substring(0, game_id.length - 2);
		window.poule_games = await fetch_poule_games(poule);

		window.game = poule_games.find(game => game.guid === game_id);
	}

	async function make_graph() {
		let xy = [{
			x: 0,
			y: 0,
		}];

		let geb_index_x = [];

		for (i = 0; i < gebeurtenis_data.GebNis.length; i++) {
			const geb = gebeurtenis_data.GebNis[i];

			if (geb.GebStatus !== 10) {
				continue;
			}

			const last_xy = xy[xy.length - 1];
			const geb_this_minute = (
				gebeurtenis_data.GebNis
				.filter(geb => (geb.GebStatus === 10))
				.filter(lgeb => geb.Periode === lgeb.Periode)
				.filter(lgeb => geb.Minuut === lgeb.Minuut)	
				.filter(lgeb => !([50, 40].includes(lgeb.GebType))) // filter out periode start, substitutions
			);
			
			if (geb.GebType === 10) {
				const split = geb.Text.split(/\b/);
				const newdiff = split[2] - split[4];

				const index_in_this_minute = geb_this_minute.findIndex(lgeb => lgeb.Index === geb.Index);
				const x = (geb.Periode - 1) * 10 + (geb.Minuut - 1) / 11 * 10 + index_in_this_minute / geb_this_minute.length;

				xy.push({
					x: x,
					y: last_xy.y,
				});
				xy.push({
					x: x,
					y: newdiff,
				});

				geb_index_x.push({
					geb_index: geb.Index,
					x: x
				});
			}
		}

		const x = xy.map(xy => xy.x);
		const y = xy.map(xy => xy.y);
		let trace = {
			x: x,
			y: y,
			type: 'scatter'
		};


		let layout = {
			xaxis: {
				title: 'Minuut'
			},
			yaxis: {
				title: 'y-axis title'
			},
			margin: {
				r: 10,
				t: 10,
			}
		};

		window.plot = await Plotly.newPlot('myDiv', [trace], layout);

		plot.on('plotly_hover', function(data){
			console.log(data)
			// debugger;
		});
	}

	const td = content => `<td>${content}</td>`;

	function make_statics() {
		let h1 = document.querySelector('body > h1');
		h1.innerText = `${game.tTNaam} - ${game.tUNaam}`;

		let quarters = document.querySelector('table#quarters');
		quarters.innerHTML = (
			`<tr>${td()}${td(FT)}${ filter(geb => geb.GebType === 40).map(s => s.split(' ').pop()).map(td)}<tr>`
		)

	}
	function make_sheets() {
		let table = document.querySelector('table#sheets');
	}

	function make_gebeurtenissen() {
		let table = document.querySelector('table#gebeurtenissen')

	}

	(async () => {
		await load_data('BVBL21229120LIHSE31ADG');

		make_graph_promise = make_graph();

		make_statics();

		await make_graph_promise;
	})();



</script>
</html>